%let appLoc=/Public/app/viyatoken; /* metadata or files service location of your app */
%let syscc=0;
options notes nosource nosource2 ps=max noquotelenmax;
%macro mp_abort(mac=mp_abort.sas, type=, msg=, iftrue=%str(1=1)
)/*/STORE SOURCE*/;
%if not(%eval(%unquote(&iftrue))) %then %return;
%put NOTE: ///  mp_abort macro executing //;
%if %length(&mac)>0 %then %put NOTE- called by &mac;
%put NOTE - &msg;
/* Stored Process Server web app context */
%if %symexist(_metaperson)
or (%symexist(SYSPROCESSNAME) and "&SYSPROCESSNAME"="Compute Server" )
%then %do;
options obs=max replace nosyntaxcheck mprint;
/* extract log errs / warns, if exist */
%local logloc logline;
%global logmsg; /* capture global messages */
%if %symexist(SYSPRINTTOLOG) %then %let logloc=&SYSPRINTTOLOG;
%else %let logloc=%qsysfunc(getoption(LOG));
proc printto log=log;run;
%if %length(&logloc)>0 %then %do;
%let logline=0;
data _null_;
infile &logloc lrecl=5000;
input; putlog _infile_;
i=1;
retain logonce 0;
if (_infile_=:"%str(WARN)ING" or _infile_=:"%str(ERR)OR") and logonce=0 then do;
call symputx('logline',_n_);
logonce+1;
end;
run;
/* capture log including lines BEFORE the err */
%if &logline>0 %then %do;
data _null_;
infile &logloc lrecl=5000;
input;
i=1;
stoploop=0;
if _n_ ge &logline-5 and stoploop=0 then do until (i>12);
call symputx('logmsg',catx('\n',symget('logmsg'),_infile_));
input;
i+1;
stoploop=1;
end;
if stoploop=1 then stop;
run;
%end;
%end;
/* send response in SASjs JSON format */
data _null_;
file _webout mod lrecl=32000;
length msg $32767 debug $8;
sasdatetime=datetime();
msg=cats(symget('msg'),'\n\nLog Extract:\n',symget('logmsg'));
/* escape the quotes */
msg=tranwrd(msg,'"','\"');
/* ditch the CRLFs as chrome complains */
msg=compress(msg,,'kw');
/* quote without quoting the quotes (which are escaped instead) */
msg=cats('"',msg,'"');
if symexist('_debug') then debug=quote(trim(symget('_debug')));
else debug='""';
if debug ge '"131"' then put '>>weboutBEGIN<<';
put '{"START_DTTM" : "' "%sysfunc(datetime(),datetime20.3)" '"';
put ',"sasjsAbort" : [{';
put ' "MSG":' msg ;
put ' ,"MAC": "' "&mac" '"}]';
put ",""SYSUSERID"" : ""&sysuserid"" ";
put ',"_DEBUG":' debug ;
if symexist('_metauser') then do;
_METAUSER=quote(trim(symget('_METAUSER')));
put ",""_METAUSER"": " _METAUSER;
_METAPERSON=quote(trim(symget('_METAPERSON')));
put ',"_METAPERSON": ' _METAPERSON;
end;
_PROGRAM=quote(trim(resolve(symget('_PROGRAM'))));
put ',"_PROGRAM" : ' _PROGRAM ;
put ",""SYSCC"" : ""&syscc"" ";
put ",""SYSERRORTEXT"" : ""&syserrortext"" ";
put ",""SYSJOBID"" : ""&sysjobid"" ";
put ",""SYSWARNINGTEXT"" : ""&syswarningtext"" ";
put ',"END_DTTM" : "' "%sysfunc(datetime(),datetime20.3)" '" ';
put "}" @;
if debug ge '"131"' then put '>>weboutEND<<';
run;
%let syscc=0;
%if %symexist(SYS_JES_JOB_URI) %then %do;
/* refer web service output to file service in one hit */
filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name="_webout.json";
%let rc=%sysfunc(fcopy(_web,_webout));
%end;
%else %if %symexist(_metaport) %then %do;
data _null_;
if symexist('sysprocessmode')
then if symget("sysprocessmode")="SAS Stored Process Server"
then rc=stpsrvset('program error', 0);
run;
%end;
%put _all_;
filename skip temp;
data _null_;
file skip;
put '%macro skip(); %macro skippy();';
run;
%inc skip;
%end;
%else %do;
%put _all_;
%abort cancel;
%end;
%mend;
%macro mf_getuniquefileref(prefix=mcref,maxtries=1000);
%local x fname;
%let x=0;
%do x=0 %to &maxtries;
%if %sysfunc(fileref(&prefix&x)) > 0 %then %do;
%let fname=&prefix&x;
%let rc=%sysfunc(filename(fname,,temp));
%if &rc %then %put %sysfunc(sysmsg());
&prefix&x
%put &sysmacroname: Fileref &prefix&x was assigned and returned;
%return;
%end;
%end;
%put unable to find available fileref in range &prefix.0-&maxtries;
%mend;
%macro mf_getuniquelibref(prefix=mclib,maxtries=1000);
%local x libref;
%let x=0;
%do x=0 %to &maxtries;
%if %sysfunc(libref(&prefix&x)) ne 0 %then %do;
%let libref=&prefix&x;
%let rc=%sysfunc(libname(&libref,%sysfunc(pathname(work))));
%if &rc %then %put %sysfunc(sysmsg());
&prefix&x
%put &sysmacroname: Libref &libref assigned as WORK and returned;
%return;
%end;
%end;
%put unable to find available libref in range &prefix.0-&maxtries;
%mend;
%macro mf_mval(var);
%if %symexist(&var) %then %do;
%superq(&var)
%end;
%mend;
%macro mf_getplatform(switch
)/*/STORE SOURCE*/;
%local a b c;
%if &switch.NONE=NONE %then %do;
%if %symexist(sysprocessmode) %then %do;
%if "&sysprocessmode"="SAS Object Server"
or "&sysprocessmode"= "SAS Compute Server" %then %do;
SASVIYA
%end;
%else %if "&sysprocessmode"="SAS Stored Process Server" %then %do;
SASMETA
%return;
%end;
%else %do;
SAS
%return;
%end;
%end;
%else %if %symexist(_metaport) %then %do;
SASMETA
%return;
%end;
%else %do;
SAS
%return;
%end;
%end;
%else %if &switch=SASSTUDIO %then %do;
/* return the version of SAS Studio else 0 */
%if %mf_mval(_CLIENTAPP)=%str(SAS Studio) %then %do;
%let a=%mf_mval(_CLIENTVERSION);
%let b=%scan(&a,1,.);
%if %eval(&b >2) %then %do;
&b
%end;
%else 0;
%end;
%else 0;
%end;
%mend;
%macro mf_isblank(param
)/*/STORE SOURCE*/;
%sysevalf(%superq(param)=,boolean)
%mend;
%macro mv_createfolder(path=
,access_token_var=ACCESS_TOKEN
,grant_type=detect
);
%local oauth_bearer;
%if &grant_type=detect %then %do;
%if %mf_getplatform(SASSTUDIO) ge 5 %then %do;
%let grant_type=sas_services;
%let &access_token_var=;
%let oauth_bearer=oauth_bearer=sas_services;
%end;
%else %if %symexist(&access_token_var) %then %let grant_type=authorization_code;
%else %let grant_type=password;
%end;
%put &sysmacroname: grant_type=&grant_type;
%mp_abort(iftrue=(&grant_type ne authorization_code and &grant_type ne password
and &grant_type ne sas_services
)
,mac=&sysmacroname
,msg=%str(Invalid value for grant_type: &grant_type)
)
%mp_abort(iftrue=(%mf_isblank(&path)=1)
,mac=&sysmacroname
,msg=%str(path value must be provided)
)
%mp_abort(iftrue=(%length(&path)=1)
,mac=&sysmacroname
,msg=%str(path value must be provided)
)
options noquotelenmax;
%local subfolder_cnt; /* determine the number of subfolders */
%let subfolder_cnt=%sysfunc(countw(&path,/));
%local href; /* resource address (none for root) */
%let href="/folders/folders?parentFolderUri=/folders/folders/none";
%local x newpath subfolder;
%do x=1 %to &subfolder_cnt;
%let subfolder=%scan(&path,&x,%str(/));
%let newpath=&newpath/&subfolder;
%local fname1;
%let fname1=%mf_getuniquefileref();
%put &sysmacroname checking to see if &newpath exists;
proc http method='GET' out=&fname1 &oauth_bearer
url="/folders/folders/@item?path=&newpath";
%if &grant_type=authorization_code %then %do;
headers "Authorization"="Bearer &&&access_token_var";
%end;
run;
%local libref1;
%let libref1=%mf_getuniquelibref();
libname &libref1 JSON fileref=&fname1;
%mp_abort(iftrue=(&SYS_PROCHTTP_STATUS_CODE ne 200 and &SYS_PROCHTTP_STATUS_CODE ne 404)
,mac=&sysmacroname
,msg=%str(&SYS_PROCHTTP_STATUS_CODE &SYS_PROCHTTP_STATUS_PHRASE)
)
%if &SYS_PROCHTTP_STATUS_CODE=200 %then %do;
%put &sysmacroname &newpath exists so grab the follow on link ;
data _null_;
set &libref1..links;
if rel='createChild' then
call symputx('href',quote(trim(href)),'l');
run;
%end;
%else %if &SYS_PROCHTTP_STATUS_CODE=404 %then %do;
%put &sysmacroname &newpath not found - creating it now;
%local fname2;
%let fname2=%mf_getuniquefileref();
data _null_;
length json $1000;
json=cats("'"
,'{"name":'
,quote(trim(symget('subfolder')))
,',"description":'
,quote("&subfolder, created by &sysmacroname")
,',"type":"folder"}'
,"'"
);
call symputx('json',json,'l');
run;
proc http method='POST'
in=&json
out=&fname2
&oauth_bearer
url=%unquote(%superq(href));
headers
%if &grant_type=authorization_code %then %do;
"Authorization"="Bearer &&&access_token_var"
%end;
'Content-Type'='application/vnd.sas.content.folder+json'
'Accept'='application/vnd.sas.content.folder+json';
run;
%put &=SYS_PROCHTTP_STATUS_CODE;
%put &=SYS_PROCHTTP_STATUS_PHRASE;
%mp_abort(iftrue=(&SYS_PROCHTTP_STATUS_CODE ne 201)
,mac=&sysmacroname
,msg=%str(&SYS_PROCHTTP_STATUS_CODE &SYS_PROCHTTP_STATUS_PHRASE)
)
%local libref2;
%let libref2=%mf_getuniquelibref();
libname &libref2 JSON fileref=&fname2;
%put &sysmacroname &newpath now created. Grabbing the follow on link ;
data _null_;
set &libref2..links;
if rel='createChild' then
call symputx('href',quote(trim(href)),'l');
run;
libname &libref2 clear;
filename &fname2 clear;
%end;
filename &fname1 clear;
libname &libref1 clear;
%end;
%mend;
%macro mv_deletejes(path=
,name=
,access_token_var=ACCESS_TOKEN
,grant_type=detect
);
%local oauth_bearer;
%if &grant_type=detect %then %do;
%if %mf_getplatform(SASSTUDIO) ge 5 %then %do;
%let grant_type=sas_services;
%let &access_token_var=;
%let oauth_bearer=oauth_bearer=sas_services;
%end;
%else %if %symexist(&access_token_var) %then %let grant_type=authorization_code;
%else %let grant_type=password;
%end;
%put &sysmacroname: grant_type=&grant_type;
%mp_abort(iftrue=(&grant_type ne authorization_code and &grant_type ne password
and &grant_type ne sas_services
)
,mac=&sysmacroname
,msg=%str(Invalid value for grant_type: &grant_type)
)
%mp_abort(iftrue=(%mf_isblank(&path)=1)
,mac=&sysmacroname
,msg=%str(path value must be provided)
)
%mp_abort(iftrue=(%mf_isblank(&name)=1)
,mac=&sysmacroname
,msg=%str(name value must be provided)
)
%mp_abort(iftrue=(%length(&path)=1)
,mac=&sysmacroname
,msg=%str(path value must be provided)
)
options noquotelenmax;
%put &sysmacroname: fetching details for &path ;
%local fname1;
%let fname1=%mf_getuniquefileref();
proc http method='GET' out=&fname1 &oauth_bearer
url="/folders/folders/@item?path=&path";
%if &grant_type=authorization_code %then %do;
headers "Authorization"="Bearer &&&access_token_var";
%end;
run;
%if &SYS_PROCHTTP_STATUS_CODE=404 %then %do;
%put &sysmacroname: Folder &path NOT FOUND - nothing to delete!;
%return;
%end;
%else %if &SYS_PROCHTTP_STATUS_CODE ne 200 %then %do;
/*data _null_;infile &fname1;input;putlog _infile_;run;*/
%mp_abort(mac=&sysmacroname
,msg=%str(&SYS_PROCHTTP_STATUS_CODE &SYS_PROCHTTP_STATUS_PHRASE)
)
%end;
%put &sysmacroname: grab the follow on link ;
%local libref1;
%let libref1=%mf_getuniquelibref();
libname &libref1 JSON fileref=&fname1;
data _null_;
set &libref1..links;
if rel='members' then call symputx('mref',quote(trim(href)),'l');
run;
/* get the children */
%local fname1a;
%let fname1a=%mf_getuniquefileref();
proc http method='GET' out=&fname1a &oauth_bearer
url=%unquote(%superq(mref));
%if &grant_type=authorization_code %then %do;
headers "Authorization"="Bearer &&&access_token_var";
%end;
run;
%put &=SYS_PROCHTTP_STATUS_CODE;
%local libref1a;
%let libref1a=%mf_getuniquelibref();
libname &libref1a JSON fileref=&fname1a;
%local uri found;
%let found=0;
%put Getting object uri from &libref1a..items;
data _null_;
set &libref1a..items;
if contenttype='jobDefinition' and name="&name" then do;
call symputx('uri',uri,'l');
call symputx('found',1,'l');
end;
run;
%if &found=0 %then %do;
%put NOTE:;%put NOTE- &sysmacroname: &path/&name NOT FOUND;%put NOTE- ;
%return;
%end;
proc http method="DELETE" url="&uri" &oauth_bearer;
headers
%if &grant_type=authorization_code %then %do;
"Authorization"="Bearer &&&access_token_var"
%end;
"Accept"="*/*";/**/
run;
%if &SYS_PROCHTTP_STATUS_CODE ne 204 %then %do;
data _null_; infile &fname2; input; putlog _infile_;run;
%mp_abort(mac=&sysmacroname
,msg=%str(&SYS_PROCHTTP_STATUS_CODE &SYS_PROCHTTP_STATUS_PHRASE)
)
%end;
%else %put &sysmacroname: &path/&name successfully deleted;
/* clear refs */
filename &fname1 clear;
libname &libref1 clear;
filename &fname1a clear;
libname &libref1a clear;
%mend;
%macro mv_createwebservice(path=
,name=
,desc=Created by the mv_createwebservice.sas macro
,precode=
,code=
,access_token_var=ACCESS_TOKEN
,grant_type=detect
,replace=NO
,adapter=sasjs
);
%local oauth_bearer;
%if &grant_type=detect %then %do;
%if %mf_getplatform(SASSTUDIO) ge 5 %then %do;
%let grant_type=sas_services;
%let &access_token_var=;
%let oauth_bearer=oauth_bearer=sas_services;
%end;
%else %if %symexist(&access_token_var) %then %let grant_type=authorization_code;
%else %let grant_type=password;
%end;
%put &sysmacroname: grant_type=&grant_type;
/* initial validation checking */
%mp_abort(iftrue=(&grant_type ne authorization_code and &grant_type ne password
and &grant_type ne sas_services
)
,mac=&sysmacroname
,msg=%str(Invalid value for grant_type: &grant_type)
)
%mp_abort(iftrue=(%mf_isblank(&path)=1)
,mac=&sysmacroname
,msg=%str(path value must be provided)
)
%mp_abort(iftrue=(%length(&path)=1)
,mac=&sysmacroname
,msg=%str(path value must be provided)
)
%mp_abort(iftrue=(%mf_isblank(&name)=1)
,mac=&sysmacroname
,msg=%str(name value must be provided)
)
options noquotelenmax;
* remove any trailing slash ;
%if "%substr(&path,%length(&path),1)" = "/" %then
%let path=%substr(&path,1,%length(&path)-1);
/* ensure folder exists */
%put &sysmacroname: Path &path being checked / created;
%mv_createfolder(path=&path)
/* fetching folder details for provided path */
%local fname1;
%let fname1=%mf_getuniquefileref();
proc http method='GET' out=&fname1 &oauth_bearer
url="/folders/folders/@item?path=&path";
%if &grant_type=authorization_code %then %do;
headers "Authorization"="Bearer &&&access_token_var";
%end;
run;
/*data _null_;infile &fname1;input;putlog _infile_;run;*/
%mp_abort(iftrue=(&SYS_PROCHTTP_STATUS_CODE ne 200)
,mac=&sysmacroname
,msg=%str(&SYS_PROCHTTP_STATUS_CODE &SYS_PROCHTTP_STATUS_PHRASE)
)
/* path exists. Grab follow on link to check members */
%local libref1;
%let libref1=%mf_getuniquelibref();
libname &libref1 JSON fileref=&fname1;
data _null_;
set &libref1..links;
if rel='members' then call symputx('membercheck',quote(trim(href)),'l');
else if rel='self' then call symputx('parentFolderUri',href,'l');
run;
data _null_;
set &libref1..root;
call symputx('folderid',id,'l');
run;
%local fname2;
%let fname2=%mf_getuniquefileref();
proc http method='GET'
out=&fname2
&oauth_bearer
url=%unquote(%superq(membercheck));
headers
%if &grant_type=authorization_code %then %do;
"Authorization"="Bearer &&&access_token_var"
%end;
'Accept'='application/vnd.sas.collection+json'
'Accept-Language'='string';
run;
/*data _null_;infile &fname2;input;putlog _infile_;run;*/
%mp_abort(iftrue=(&SYS_PROCHTTP_STATUS_CODE ne 200)
,mac=&sysmacroname
,msg=%str(&SYS_PROCHTTP_STATUS_CODE &SYS_PROCHTTP_STATUS_PHRASE)
)
%if %upcase(&replace)=YES %then %do;
%mv_deletejes(path=&path, name=&name)
%end;
%else %do;
/* check that job does not already exist in that folder */
%local libref2;
%let libref2=%mf_getuniquelibref();
libname &libref2 JSON fileref=&fname2;
%local exists; %let exists=0;
data _null_;
set &libref2..items;
if contenttype='jobDefinition' and upcase(name)="%upcase(&name)" then
call symputx('exists',1,'l');
run;
%mp_abort(iftrue=(&exists=1)
,mac=&sysmacroname
,msg=%str(Job &name already exists in &path)
)
libname &libref2 clear;
%end;
/* set up the body of the request to create the service */
%local fname3;
%let fname3=%mf_getuniquefileref();
data _null_;
file &fname3 TERMSTR=' ';
string=cats('{"version": 0,"name":"'
,"&name"
,'","type":"Compute","parameters":[{"name":"_addjesbeginendmacros"'
,',"type":"CHARACTER","defaultValue":"false"}]'
,',"code":"');
put string;
run;
filename sasjs temp lrecl=3000;
data _null_;
file sasjs;
put "/* Created on %sysfunc(datetime(),datetime19.) by &sysuserid */";
/* WEBOUT BEGIN */
put ' ';
put '%macro mp_jsonout(action,ds,jref=_webout,dslabel=,fmt=Y,engine=PROCJSON,dbg=0 ';
put ')/*/STORE SOURCE*/; ';
put '%put output location=&jref; ';
put '%if &action=OPEN %then %do; ';
put '  data _null_;file &jref encoding=''utf-8''; ';
put '    put ''{"START_DTTM" : "'' "%sysfunc(datetime(),datetime20.3)" ''"''; ';
put '  run; ';
put '%end; ';
put '%else %if (&action=ARR or &action=OBJ) %then %do; ';
put '  options validvarname=upcase; ';
put '  data _null_;file &jref mod encoding=''utf-8''; ';
put '    put ", ""%lowcase(%sysfunc(coalescec(&dslabel,&ds)))"":"; ';
put ' ';
put '  %if &engine=PROCJSON %then %do; ';
put '    data;run;%let tempds=&syslast; ';
put '    proc sql;drop table &tempds; ';
put '    data &tempds /view=&tempds;set &ds; ';
put '    %if &fmt=N %then format _numeric_ best32.;; ';
put '    proc json out=&jref ';
put '        %if &action=ARR %then nokeys ; ';
put '        %if &dbg ge 131  %then pretty ; ';
put '        ;export &tempds / nosastags fmtnumeric; ';
put '    run; ';
put '    proc sql;drop view &tempds; ';
put '  %end; ';
put '  %else %if &engine=DATASTEP %then %do; ';
put '    %local cols i tempds; ';
put '    %let cols=0; ';
put '    %if %sysfunc(exist(&ds)) ne 1 & %sysfunc(exist(&ds,VIEW)) ne 1 %then %do; ';
put '      %put &sysmacroname:  &ds NOT FOUND!!!; ';
put '      %return; ';
put '    %end; ';
put '    data _null_;file &jref mod ; ';
put '      put "["; call symputx(''cols'',0,''l''); ';
put '    proc sort data=sashelp.vcolumn(where=(libname=''WORK'' & memname="%upcase(&ds)")) ';
put '      out=_data_; ';
put '      by varnum; ';
put ' ';
put '    data _null_; ';
put '      set _last_ end=last; ';
put '      call symputx(cats(''name'',_n_),name,''l''); ';
put '      call symputx(cats(''type'',_n_),type,''l''); ';
put '      call symputx(cats(''len'',_n_),length,''l''); ';
put '      if last then call symputx(''cols'',_n_,''l''); ';
put '    run; ';
put ' ';
put '    proc format; /* credit yabwon for special null removal */ ';
put '      value bart ._ - .z = null ';
put '      other = [best.]; ';
put ' ';
put '    data;run; %let tempds=&syslast; /* temp table for spesh char management */ ';
put '    proc sql; drop table &tempds; ';
put '    data &tempds/view=&tempds; ';
put '      attrib _all_ label=''''; ';
put '      %do i=1 %to &cols; ';
put '        %if &&type&i=char %then %do; ';
put '          length &&name&i $32767; ';
put '          format &&name&i $32767.; ';
put '        %end; ';
put '      %end; ';
put '      set &ds; ';
put '      format _numeric_ bart.; ';
put '    %do i=1 %to &cols; ';
put '      %if &&type&i=char %then %do; ';
put '        &&name&i=''"''!!trim(prxchange(''s/"/\"/'',-1, ';
put '                    prxchange(''s/''!!''0A''x!!''/\n/'',-1, ';
put '                    prxchange(''s/''!!''0D''x!!''/\r/'',-1, ';
put '                    prxchange(''s/''!!''09''x!!''/\t/'',-1, ';
put '                    prxchange(''s/\\/\\\\/'',-1,&&name&i) ';
put '        )))))!!''"''; ';
put '      %end; ';
put '    %end; ';
put '    run; ';
put '    /* write to temp loc to avoid _webout truncation - https://support.sas.com/kb/49/325.html */ ';
put '    filename _sjs temp lrecl=131068 encoding=''utf-8''; ';
put '    data _null_; file _sjs lrecl=131068 encoding=''utf-8'' mod; ';
put '      set &tempds; ';
put '      if _n_>1 then put "," @; put ';
put '      %if &action=ARR %then "[" ; %else "{" ; ';
put '      %do i=1 %to &cols; ';
put '        %if &i>1 %then  "," ; ';
put '        %if &action=OBJ %then """&&name&i"":" ; ';
put '        &&name&i ';
put '      %end; ';
put '      %if &action=ARR %then "]" ; %else "}" ; ; ';
put '    proc sql; ';
put '    drop view &tempds; ';
put '    /* now write the long strings to _webout 1 byte at a time */ ';
put '    data _null_; ';
put '      length filein 8 fileid 8; ';
put '      filein = fopen("_sjs",''I'',1,''B''); ';
put '      fileid = fopen("&jref",''A'',1,''B''); ';
put '      rec = ''20''x; ';
put '      do while(fread(filein)=0); ';
put '        rc = fget(filein,rec,1); ';
put '        rc = fput(fileid, rec); ';
put '        rc =fwrite(fileid); ';
put '      end; ';
put '      rc = fclose(filein); ';
put '      rc = fclose(fileid); ';
put '    run; ';
put '    filename _sjs clear; ';
put '    data _null_; file &jref mod encoding=''utf-8''; ';
put '      put "]"; ';
put '    run; ';
put '  %end; ';
put '%end; ';
put ' ';
put '%else %if &action=CLOSE %then %do; ';
put '  data _null_;file &jref encoding=''utf-8''; ';
put '    put "}"; ';
put '  run; ';
put '%end; ';
put '%mend; ';
put '%macro mv_webout(action,ds,fref=_mvwtemp,dslabel=,fmt=Y); ';
put '%global _webin_file_count _webout_fileuri _debug _omittextlog ; ';
put '%if %index("&_debug",log) %then %let _debug=131; ';
put ' ';
put '%local i tempds; ';
put '%let action=%upcase(&action); ';
put ' ';
put '%if &action=FETCH %then %do; ';
put '  %if %upcase(&_omittextlog)=FALSE or %str(&_debug) ge 131 %then %do; ';
put '    options mprint notes mprintnest; ';
put '  %end; ';
put ' ';
put '  %if not %symexist(_webout_fileuri1) %then %do; ';
put '    %let _webin_file_count=%eval(&_webin_file_count+0); ';
put '    %let _webout_fileuri1=&_webout_fileuri; ';
put '  %end; ';
put ' ';
put '  %if %symexist(sasjs_tables) %then %do; ';
put '    /* small volumes of non-special data are sent as params for responsiveness */ ';
put '    filename _sasjs "%sysfunc(pathname(work))/sasjs.lua"; ';
put '    data _null_; ';
put '      file _sasjs; ';
put '      put ''s=sas.symget("sasjs_tables")''; ';
put '      put ''if(s:sub(1,7) == "%nrstr(")''; ';
put '      put ''then''; ';
put '      put '' tablist=s:sub(8,s:len()-1)''; ';
put '      put ''else''; ';
put '      put '' tablist=s''; ';
put '      put ''end''; ';
put '      put ''for i = 1,sas.countw(tablist) ''; ';
put '      put ''do ''; ';
put '      put ''  tab=sas.scan(tablist,i)''; ';
put '      put ''  sasdata=""''; ';
put '      put ''  if (sas.symexist("sasjs"..i.."data0")==0)''; ';
put '      put ''  then''; ';
put '      /* TODO - condense this logic */ ';
put '      put ''    s=sas.symget("sasjs"..i.."data")''; ';
put '      put ''    if(s:sub(1,7) == "%nrstr(")''; ';
put '      put ''    then''; ';
put '      put ''      sasdata=s:sub(8,s:len()-1)''; ';
put '      put ''    else''; ';
put '      put ''      sasdata=s''; ';
put '      put ''    end''; ';
put '      put ''  else''; ';
put '      put ''    for d = 1, sas.symget("sasjs"..i.."data0")''; ';
put '      put ''    do''; ';
put '      put ''      s=sas.symget("sasjs"..i.."data"..d)''; ';
put '      put ''      if(s:sub(1,7) == "%nrstr(")''; ';
put '      put ''      then''; ';
put '      put ''        sasdata=sasdata..s:sub(8,s:len()-1)''; ';
put '      put ''      else''; ';
put '      put ''        sasdata=sasdata..s''; ';
put '      put ''      end''; ';
put '      put ''    end''; ';
put '      put ''  end''; ';
put '      put ''  file = io.open(sas.pathname("work").."/"..tab..".csv", "a")''; ';
put '      put ''  io.output(file)''; ';
put '      put ''  io.write(sasdata)''; ';
put '      put ''  io.close(file)''; ';
put '      put ''end''; ';
put '    run; ';
put '    %inc _sasjs; ';
put ' ';
put '    /* now read in the data */ ';
put '    %do i=1 %to %sysfunc(countw(&sasjs_tables)); ';
put '      %local table; %let table=%scan(&sasjs_tables,&i); ';
put '      data _null_; ';
put '        infile "%sysfunc(pathname(work))/&table..csv" termstr=crlf ; ';
put '        input; ';
put '        if _n_=1 then call symputx(''input_statement'',_infile_); ';
put '        list; ';
put '      data &table; ';
put '        infile "%sysfunc(pathname(work))/&table..csv" firstobs=2 dsd termstr=crlf; ';
put '        input &input_statement; ';
put '      run; ';
put '    %end; ';
put '  %end; ';
put '  %else %do i=1 %to &_webin_file_count; ';
put '    /* read in any files that are sent */ ';
put '    filename indata filesrvc "&&_webout_fileuri&i" lrecl=999999; ';
put '    data _null_; ';
put '      infile indata termstr=crlf ; ';
put '      input; ';
put '      if _n_=1 then call symputx(''input_statement'',_infile_); ';
put '      %if %str(&_debug) ge 131 %then %do; ';
put '        if _n_<20 then putlog _infile_; ';
put '        else stop; ';
put '      %end; ';
put '      %else %do; ';
put '        stop; ';
put '      %end; ';
put '    run; ';
put '    data &&_webin_name&i; ';
put '      infile indata firstobs=2 dsd termstr=crlf ; ';
put '      input &input_statement; ';
put '    run; ';
put '  %end; ';
put '%end; ';
put '%else %if &action=OPEN %then %do; ';
put '  /* setup webout */ ';
put '  OPTIONS NOBOMFILE; ';
put '  filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" ';
put '    name="_webout.json" lrecl=999999 mod; ';
put ' ';
put '  /* setup temp ref */ ';
put '  %if %upcase(&fref) ne _WEBOUT %then %do; ';
put '    filename &fref temp lrecl=999999 permission=''A::u::rwx,A::g::rw-,A::o::---'' mod; ';
put '  %end; ';
put ' ';
put '  /* setup json */ ';
put '  data _null_;file &fref; ';
put '    put ''{"START_DTTM" : "'' "%sysfunc(datetime(),datetime20.3)" ''"''; ';
put '  run; ';
put '%end; ';
put '%else %if &action=ARR or &action=OBJ %then %do; ';
put '    %mp_jsonout(&action,&ds,dslabel=&dslabel,fmt=&fmt ';
put '      ,jref=&fref,engine=PROCJSON,dbg=%str(&_debug) ';
put '    ) ';
put '%end; ';
put '%else %if &action=CLOSE %then %do; ';
put '  %if %str(&_debug) ge 131 %then %do; ';
put '    /* send back first 10 records of each work table for debugging */ ';
put '    options obs=10; ';
put '    data;run;%let tempds=%scan(&syslast,2,.); ';
put '    ods output Members=&tempds; ';
put '    proc datasets library=WORK memtype=data; ';
put '    %local wtcnt;%let wtcnt=0; ';
put '    data _null_; set &tempds; ';
put '      if not (name =:"DATA"); ';
put '      i+1; ';
put '      call symputx(''wt''!!left(i),name); ';
put '      call symputx(''wtcnt'',i); ';
put '    data _null_; file &fref; put ",""WORK"":{"; ';
put '    %do i=1 %to &wtcnt; ';
put '      %let wt=&&wt&i; ';
put '      proc contents noprint data=&wt ';
put '        out=_data_ (keep=name type length format:); ';
put '      run;%let tempds=%scan(&syslast,2,.); ';
put '      data _null_; file &fref; ';
put '        dsid=open("WORK.&wt",''is''); ';
put '        nlobs=attrn(dsid,''NLOBS''); ';
put '        nvars=attrn(dsid,''NVARS''); ';
put '        rc=close(dsid); ';
put '        if &i>1 then put '',''@; ';
put '        put " ""&wt"" : {"; ';
put '        put ''"nlobs":'' nlobs; ';
put '        put '',"nvars":'' nvars; ';
put '      %mp_jsonout(OBJ,&tempds,jref=&fref,dslabel=colattrs,engine=DATASTEP) ';
put '      %mp_jsonout(OBJ,&wt,jref=&fref,dslabel=first10rows,engine=DATASTEP) ';
put '      data _null_; file &fref;put "}"; ';
put '    %end; ';
put '    data _null_; file &fref;put "}";run; ';
put '  %end; ';
put ' ';
put '  /* close off json */ ';
put '  data _null_;file &fref mod; ';
put '    _PROGRAM=quote(trim(resolve(symget(''_PROGRAM'')))); ';
put '    put ",""SYSUSERID"" : ""&sysuserid"" "; ';
put '    put ",""MF_GETUSER"" : ""%mf_getuser()"" "; ';
put '    SYS_JES_JOB_URI=quote(trim(resolve(symget(''SYS_JES_JOB_URI'')))); ';
put '    put '',"SYS_JES_JOB_URI" : '' SYS_JES_JOB_URI ; ';
put '    put ",""SYSJOBID"" : ""&sysjobid"" "; ';
put '    put ",""_DEBUG"" : ""&_debug"" "; ';
put '    put '',"_PROGRAM" : '' _PROGRAM ; ';
put '    put ",""SYSCC"" : ""&syscc"" "; ';
put '    put ",""SYSERRORTEXT"" : ""&syserrortext"" "; ';
put '    put ",""SYSHOSTNAME"" : ""&syshostname"" "; ';
put '    put ",""SYSSITE"" : ""&syssite"" "; ';
put '    put ",""SYSWARNINGTEXT"" : ""&syswarningtext"" "; ';
put '    put '',"END_DTTM" : "'' "%sysfunc(datetime(),datetime20.3)" ''" ''; ';
put '    put "}"; ';
put ' ';
put '  %if %upcase(&fref) ne _WEBOUT %then %do; ';
put '    data _null_; rc=fcopy("&fref","_webout");run; ';
put '  %end; ';
put ' ';
put '%end; ';
put ' ';
put '%mend; ';
put ' ';
put '%macro mf_getuser(type=META ';
put ')/*/STORE SOURCE*/; ';
put '  %local user metavar; ';
put '  %if &type=OS %then %let metavar=_secureusername; ';
put '  %else %let metavar=_metaperson; ';
put ' ';
put '  %if %symexist(SYS_COMPUTE_SESSION_OWNER) %then %let user=&SYS_COMPUTE_SESSION_OWNER; ';
put '  %else %if %symexist(&metavar) %then %do; ';
put '    %if %length(&&&metavar)=0 %then %let user=&sysuserid; ';
put '    /* sometimes SAS will add @domain extension - remove for consistency */ ';
put '    %else %let user=%scan(&&&metavar,1,@); ';
put '  %end; ';
put '  %else %let user=&sysuserid; ';
put ' ';
put '  %quote(&user) ';
put ' ';
put '%mend; ';
/* WEBOUT END */
put '%macro webout(action,ds,dslabel=,fmt=);';
put '  %mv_webout(&action,ds=&ds,dslabel=&dslabel,fmt=&fmt)';
put '%mend;';
run;
/* insert the code, escaping double quotes and carriage returns */
%local x fref freflist;
%let freflist= &adapter &precode &code ;
%do x=1 %to %sysfunc(countw(&freflist));
%let fref=%scan(&freflist,&x);
%put &sysmacroname: adding &fref;
data _null_;
length filein 8 fileid 8;
filein = fopen("&fref","I",1,"B");
fileid = fopen("&fname3","A",1,"B");
rec = "20"x;
do while(fread(filein)=0);
rc = fget(filein,rec,1);
if rec='"' then do;
rc =fput(fileid,'\');rc =fwrite(fileid);
rc =fput(fileid,'"');rc =fwrite(fileid);
end;
else if rec='0A'x then do;
rc =fput(fileid,'\');rc =fwrite(fileid);
rc =fput(fileid,'r');rc =fwrite(fileid);
end;
else if rec='0D'x then do;
rc =fput(fileid,'\');rc =fwrite(fileid);
rc =fput(fileid,'n');rc =fwrite(fileid);
end;
else if rec='09'x then do;
rc =fput(fileid,'\');rc =fwrite(fileid);
rc =fput(fileid,'t');rc =fwrite(fileid);
end;
else if rec='5C'x then do;
rc =fput(fileid,'\');rc =fwrite(fileid);
rc =fput(fileid,'\');rc =fwrite(fileid);
end;
else do;
rc =fput(fileid,rec);
rc =fwrite(fileid);
end;
end;
rc=fclose(filein);
rc=fclose(fileid);
run;
%end;
/* finish off the body of the code file loaded to JES */
data _null_;
file &fname3 mod TERMSTR=' ';
put '"}';
run;
/* now we can create the job!! */
%local fname4;
%let fname4=%mf_getuniquefileref();
proc http method='POST'
in=&fname3
out=&fname4
&oauth_bearer
url="/jobDefinitions/definitions?parentFolderUri=&parentFolderUri";
headers 'Content-Type'='application/vnd.sas.job.definition+json'
%if &grant_type=authorization_code %then %do;
"Authorization"="Bearer &&&access_token_var"
%end;
"Accept"="application/vnd.sas.job.definition+json";
run;
/*data _null_;infile &fname4;input;putlog _infile_;run;*/
%mp_abort(iftrue=(&SYS_PROCHTTP_STATUS_CODE ne 201)
,mac=&sysmacroname
,msg=%str(&SYS_PROCHTTP_STATUS_CODE &SYS_PROCHTTP_STATUS_PHRASE)
)
/* clear refs */
filename &fname1 clear;
filename &fname2 clear;
filename &fname3 clear;
filename &fname4 clear;
filename &adapter clear;
libname &libref1 clear;
/* get the url so we can give a helpful log message */
%local url;
data _null_;
if symexist('_baseurl') then do;
url=symget('_baseurl');
if subpad(url,length(url)-9,9)='SASStudio'
then url=substr(url,1,length(url)-11);
else url="&systcpiphostname";
end;
else url="&systcpiphostname";
call symputx('url',url);
run;
%put &sysmacroname: Job &name successfully created in &path;
%put &sysmacroname:;
%put &sysmacroname: Check it out here:;
%put &sysmacroname:;
%put &sysmacroname:   &url/SASJobExecution?_PROGRAM=&path/&name;
%put &sysmacroname:;
%put &sysmacroname:;
%mend;
%let path=;
%let service=clickme;
filename sascode temp lrecl=32767;
data _null_;
file sascode;
put '%macro sasjsout(type,fref=sasjs);';
put '%global sysprocessmode SYS_JES_JOB_URI;';
put '%if "&sysprocessmode"="SAS Compute Server" %then %do;';
put '%if &type=HTML %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name="_webout.json"';
put 'contenttype="text/html";';
put '%end;';
put '%else %if &type=JS %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name=''_webout.js''';
put 'contenttype=''application/javascript'';';
put '%end;';
put '%else %if &type=CSS %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name=''_webout.css''';
put 'contenttype=''text/css'';';
put '%end;';
put '%else %if &type=PNG %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name=''_webout.png''';
put 'contenttype=''image/png'' lrecl=2000000 recfm=n;';
put '%end;';
put '%else %if &type=MP3 %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name=''_webout.mp3''';
put 'contenttype=''audio/mpeg'' lrecl=2000000 recfm=n;';
put '%end;';
put '%end;';
put '%else %do;';
put '%if &type=JS %then %do;';
put '%let rc=%sysfunc(stpsrv_header(Content-type,application/javascript));';
put '%end;';
put '%else %if &type=CSS %then %do;';
put '%let rc=%sysfunc(stpsrv_header(Content-type,text/css));';
put '%end;';
put '%else %if &type=PNG %then %do;';
put '%let rc=%sysfunc(stpsrv_header(Content-type,image/png));';
put '%end;';
put '%else %if &type=MP3 %then %do;';
put '%let rc=%sysfunc(stpsrv_header(Content-type,audio/mpeg));';
put '%end;';
put '%end;';
put '%if &type=HTML %then %do;';
put 'filename _sjs temp;';
put 'data _null_;';
put 'file _sjs lrecl=32767 encoding=''utf-8'';';
put 'infile &fref lrecl=32767;';
put 'input;';
put 'if find(_infile_,'' appLoc: '') then do;';
put 'pgm="&_program";';
put 'rootlen=length(trim(pgm))-length(scan(pgm,-1,''/''))-1;';
put 'root=quote(substr(pgm,1,rootlen));';
put 'put ''    appLoc: '' root '','';';
put 'end;';
put 'else if find(_infile_,'' serverType: '') then do;';
put 'if symexist(''_metaperson'') then put ''    serverType: "SAS9" ,'';';
put 'else put ''    serverType: "SASVIYA" ,'';';
put 'end;';
put 'else if find(_infile_,'' hostUrl: '') then do;';
put '/* nothing - we are streaming so this will default to hostname */';
put 'end;';
put 'else put _infile_;';
put 'run;';
put '%let fref=_sjs;';
put '%end;';
put '/* stream byte by byte */';
put '%if &type=PNG or &type=MP3 %then %do;';
put 'data _null_;';
put 'length filein 8 fileout 8;';
put 'filein = fopen("&fref",''I'',4,''B'');';
put 'fileout = fopen("_webout",''A'',1,''B'');';
put 'char= ''20''x;';
put 'do while(fread(filein)=0);';
put 'raw="1234";';
put 'do i=1 to 4;';
put 'rc=fget(filein,char,1);';
put 'substr(raw,i,1)=char;';
put 'end;';
put 'val="123";';
put 'val=input(raw,$base64X4.);';
put 'do i=1 to 3;';
put 'length byte $1;';
put 'byte=byte(rank(substr(val,i,1)));';
put 'rc = fput(fileout, byte);';
put 'end;';
put 'rc =fwrite(fileout);';
put 'end;';
put 'rc = fclose(filein);';
put 'rc = fclose(fileout);';
put 'run;';
put '%end;';
put '%else %do;';
put 'data _null_;';
put 'length filein 8 fileid 8;';
put 'filein = fopen("&fref",''I'',1,''B'');';
put 'fileid = fopen("_webout",''A'',1,''B'');';
put 'rec = ''20''x;';
put 'do while(fread(filein)=0);';
put 'rc = fget(filein,rec,1);';
put 'rc = fput(fileid, rec);';
put 'rc =fwrite(fileid);';
put 'end;';
put 'rc = fclose(filein);';
put 'rc = fclose(fileid);';
put 'run;';
put '%end;';
put '%mend;';
put 'filename sasjs temp lrecl=99999999;';
put 'data _null_;';
put 'file sasjs;';
put 'put ''<!DOCTYPE html><html><head>'';';
put 'put ''    <meta charset="utf-8" http-equiv="X-UA-Compatible" content="IE=edge">'';';
put 'put ''    <link href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="stylesheet">'';';
put 'put '' '';';
put 'put ''    <script>'';';
put 'put ''      function initSasJs() {'';';
put 'put ''        sasJs = new SASjs.default({'';';
put 'put ''          appLoc: "/Public/app/viyatoken",'';';
put 'put ''          serverType: "SASVIYA",'';';
put 'put ''          debug: false,'';';
put 'put ''        });'';';
put 'put ''      }'';';
put 'put ''    </script>'';';
put 'put '' '';';
put 'put ''    <script src="/SASJobExecution?_PROGRAM=/Public/app/viyatoken/webv/indexjs"></script>'';';
put 'put ''    <script src="/SASJobExecution?_PROGRAM=/Public/app/viyatoken/webv/scriptsjs"></script>'';';
put 'put '' '';';
put 'put ''    <title>ViyaToken</title>'';';
put 'put ''  </head>'';';
put 'put ''  <body onload="initSasJs()">'';';
put 'put ''    <button class="secHide" id="refresh" onclick="refreshPage()">Refresh</button>'';';
put 'put ''    <h1>'';';
put 'put ''      SASjs Viya Token Generator'';';
put 'put ''    </h1>'';';
put 'put '' '';';
put 'put ''    <h4 class="secHide">.env Format <span class="copy-icon" onclick="copyText(''''token-info-env'''')"></span></h4>'';';
put 'put ''    <p class="secHide">Suitable for copy pasting into a .env file</p>'';';
put 'put ''    <p id="token-info-env" class="secHide"></p>'';';
put 'put ''    <h4 class="secHide">JSON Format <span class="copy-icon" onclick="copyText(''''token-info'''')"></span></h4>'';';
put 'put ''    <p class="secHide">Suitable for copy pasting into the <a href="https://sasjs.io">SASjs</a> Config file</p>'';';
put 'put ''    <p id="token-info" class="secHide"></p>'';';
put 'put ''    <h4 class="secHide">SAS Format <span class="copy-icon" onclick="copyText(''''token-info-macro'''')"></span></h4>'';';
put 'put ''    <p class="secHide">'';';
put 'put ''    Suitable for including in SAS Programs that use the <a href="https://github.com/sasjs/core">MacroCore</a> library'';';
put 'put ''    </p>'';';
put 'put ''    <p id="token-info-macro" class="secHide"></p>'';';
put 'put ''    <button id="generate-token" onclick="generateToken()">Generate token</button>'';';
put 'put ''    <div style="display: none;" class="login-form" id="login-form">'';';
put 'put ''      <input type="text" id="username" placeholder="Enter username">'';';
put 'put ''      <input type="password" id="password" placeholder="Enter password">'';';
put 'put '' '';';
put 'put ''      <button id="login" onclick="login()">Log in</button>'';';
put 'put ''    </div>'';';
put 'put '' '';';
put 'put ''    <style>'';';
put 'put ''        * {'';';
put 'put ''            font-family: "Roboto", sans-serif;'';';
put 'put ''        }'';';
put 'put '' '';';
put 'put ''        body {'';';
put 'put ''            display: flex;'';';
put 'put ''            flex-direction: column;'';';
put 'put ''            justify-content: center;'';';
put 'put ''            align-items: center;'';';
put 'put ''            min-height: 100vh;'';';
put 'put ''            margin: 0;'';';
put 'put ''            padding-bottom: 30px;'';';
put 'put ''        }'';';
put 'put '' '';';
put 'put ''        button {'';';
put 'put ''            background-color: #3f51b5;'';';
put 'put ''            color: #ffffff;'';';
put 'put ''            border: none;'';';
put 'put ''            padding: 10px 30px;'';';
put 'put ''            border-radius: 5px;'';';
put 'put ''            font-size: 16px;'';';
put 'put ''            cursor: pointer;'';';
put 'put ''            margin: 10px 0;'';';
put 'put ''        }'';';
put 'put '' '';';
put 'put ''            button:focus,'';';
put 'put ''            input:focus {'';';
put 'put ''            outline: none;'';';
put 'put ''        }'';';
put 'put '' '';';
put 'put ''        button:hover {'';';
put 'put ''            box-shadow: inset 0 0 100px 100px rgba(255, 255, 255, 0.1);'';';
put 'put ''        }'';';
put 'put '' '';';
put 'put ''        .login-form {'';';
put 'put ''            display: flex;'';';
put 'put ''            flex-direction: column;'';';
put 'put ''        }'';';
put 'put '' '';';
put 'put ''        .login-form input {'';';
put 'put ''            padding: 10px;'';';
put 'put ''            border-radius: 5px;'';';
put 'put ''            font-size: 20px;'';';
put 'put ''            border: 1px solid #d9d9d9;'';';
put 'put ''            margin-top: 5px;'';';
put 'put ''        }'';';
put 'put '' '';';
put 'put ''        .secHide{'';';
put 'put ''          display:none'';';
put 'put ''        }'';';
put 'put '' '';';
put 'put ''        #token-info, #token-info-macro, #token-info-env {'';';
put 'put ''            background: #f7f5f5;'';';
put 'put ''            padding: 20px;'';';
put 'put ''            border: 1px solid gainsboro;'';';
put 'put ''            align-self: center;'';';
put 'put ''            white-space: pre;'';';
put 'put ''            width: 95%;'';';
put 'put ''            overflow-x: auto;'';';
put 'put ''            /* white-space: pre-wrap;'';';
put 'put ''            word-break: break-word;'';';
put 'put ''            width: 95%; */'';';
put 'put ''        }'';';
put 'put '' '';';
put 'put ''        #token-info-macro {'';';
put 'put ''            margin-top: 20px;'';';
put 'put ''            /* word-break: break-all; */'';';
put 'put ''        }'';';
put 'put '' '';';
put 'put ''        .copy-icon {'';';
put 'put ''          cursor: pointer;'';';
put 'put ''          width: 20px;'';';
put 'put ''          height: 20px;'';';
put 'put ''          display: inline-block;'';';
put 'put ''          background-size: contain;'';';
put 'put ''          background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMjIgNnYxNmgtMTZ2LTE2aDE2em0yLTJoLTIwd''@;';
put 'put ''jIwaDIwdi0yMHptLTI0IDE3di0yMWgyMXYyaC0xOXYxOWgtMnoiLz48L3N2Zz4=");'';';
put 'put ''        }'';';
put 'put ''    </style>'';';
put 'put ''  '';';
put 'put ''</body></html>'';';
put 'run;';
put '%sasjsout(HTML)';
run;
%mv_createwebservice(path=&appLoc/&path, name=&service, code=sascode ,replace=yes)
filename sascode clear;
%let path=admin;
%let service=getapptoken;
filename sascode temp lrecl=32767;
data _null_;
file sascode;
put '* Service Variables start;';
put '*Service Variables end;';
put '* Dependencies start;';
put '%macro mp_abort(mac=mp_abort.sas, type=, msg=, iftrue=%str(1=1)';
put ')/*/STORE SOURCE*/;';
put '%if not(%eval(%unquote(&iftrue))) %then %return;';
put '%put NOTE: ///  mp_abort macro executing //;';
put '%if %length(&mac)>0 %then %put NOTE- called by &mac;';
put '%put NOTE - &msg;';
put '/* Stored Process Server web app context */';
put '%if %symexist(_metaperson)';
put 'or (%symexist(SYSPROCESSNAME) and "&SYSPROCESSNAME"="Compute Server" )';
put '%then %do;';
put 'options obs=max replace nosyntaxcheck mprint;';
put '/* extract log errs / warns, if exist */';
put '%local logloc logline;';
put '%global logmsg; /* capture global messages */';
put '%if %symexist(SYSPRINTTOLOG) %then %let logloc=&SYSPRINTTOLOG;';
put '%else %let logloc=%qsysfunc(getoption(LOG));';
put 'proc printto log=log;run;';
put '%if %length(&logloc)>0 %then %do;';
put '%let logline=0;';
put 'data _null_;';
put 'infile &logloc lrecl=5000;';
put 'input; putlog _infile_;';
put 'i=1;';
put 'retain logonce 0;';
put 'if (_infile_=:"%str(WARN)ING" or _infile_=:"%str(ERR)OR") and logonce=0 then do;';
put 'call symputx(''logline'',_n_);';
put 'logonce+1;';
put 'end;';
put 'run;';
put '/* capture log including lines BEFORE the err */';
put '%if &logline>0 %then %do;';
put 'data _null_;';
put 'infile &logloc lrecl=5000;';
put 'input;';
put 'i=1;';
put 'stoploop=0;';
put 'if _n_ ge &logline-5 and stoploop=0 then do until (i>12);';
put 'call symputx(''logmsg'',catx(''\n'',symget(''logmsg''),_infile_));';
put 'input;';
put 'i+1;';
put 'stoploop=1;';
put 'end;';
put 'if stoploop=1 then stop;';
put 'run;';
put '%end;';
put '%end;';
put '/* send response in SASjs JSON format */';
put 'data _null_;';
put 'file _webout mod lrecl=32000;';
put 'length msg $32767 debug $8;';
put 'sasdatetime=datetime();';
put 'msg=cats(symget(''msg''),''\n\nLog Extract:\n'',symget(''logmsg''));';
put '/* escape the quotes */';
put 'msg=tranwrd(msg,''"'',''\"'');';
put '/* ditch the CRLFs as chrome complains */';
put 'msg=compress(msg,,''kw'');';
put '/* quote without quoting the quotes (which are escaped instead) */';
put 'msg=cats(''"'',msg,''"'');';
put 'if symexist(''_debug'') then debug=quote(trim(symget(''_debug'')));';
put 'else debug=''""'';';
put 'if debug ge ''"131"'' then put ''>>weboutBEGIN<<'';';
put 'put ''{"START_DTTM" : "'' "%sysfunc(datetime(),datetime20.3)" ''"'';';
put 'put '',"sasjsAbort" : [{'';';
put 'put '' "MSG":'' msg ;';
put 'put '' ,"MAC": "'' "&mac" ''"}]'';';
put 'put ",""SYSUSERID"" : ""&sysuserid"" ";';
put 'put '',"_DEBUG":'' debug ;';
put 'if symexist(''_metauser'') then do;';
put '_METAUSER=quote(trim(symget(''_METAUSER'')));';
put 'put ",""_METAUSER"": " _METAUSER;';
put '_METAPERSON=quote(trim(symget(''_METAPERSON'')));';
put 'put '',"_METAPERSON": '' _METAPERSON;';
put 'end;';
put '_PROGRAM=quote(trim(resolve(symget(''_PROGRAM''))));';
put 'put '',"_PROGRAM" : '' _PROGRAM ;';
put 'put ",""SYSCC"" : ""&syscc"" ";';
put 'put ",""SYSERRORTEXT"" : ""&syserrortext"" ";';
put 'put ",""SYSJOBID"" : ""&sysjobid"" ";';
put 'put ",""SYSWARNINGTEXT"" : ""&syswarningtext"" ";';
put 'put '',"END_DTTM" : "'' "%sysfunc(datetime(),datetime20.3)" ''" '';';
put 'put "}" @;';
put 'if debug ge ''"131"'' then put ''>>weboutEND<<'';';
put 'run;';
put '%let syscc=0;';
put '%if %symexist(SYS_JES_JOB_URI) %then %do;';
put '/* refer web service output to file service in one hit */';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name="_webout.json";';
put '%let rc=%sysfunc(fcopy(_web,_webout));';
put '%end;';
put '%else %if %symexist(_metaport) %then %do;';
put 'data _null_;';
put 'if symexist(''sysprocessmode'')';
put 'then if symget("sysprocessmode")="SAS Stored Process Server"';
put 'then rc=stpsrvset(''program error'', 0);';
put 'run;';
put '%end;';
put '%put _all_;';
put 'filename skip temp;';
put 'data _null_;';
put 'file skip;';
put 'put ''%macro skip(); %macro skippy();'';';
put 'run;';
put '%inc skip;';
put '%end;';
put '%else %do;';
put '%put _all_;';
put '%abort cancel;';
put '%end;';
put '%mend;';
put '%macro mf_getuniquefileref(prefix=mcref,maxtries=1000);';
put '%local x fname;';
put '%let x=0;';
put '%do x=0 %to &maxtries;';
put '%if %sysfunc(fileref(&prefix&x)) > 0 %then %do;';
put '%let fname=&prefix&x;';
put '%let rc=%sysfunc(filename(fname,,temp));';
put '%if &rc %then %put %sysfunc(sysmsg());';
put '&prefix&x';
put '%put &sysmacroname: Fileref &prefix&x was assigned and returned;';
put '%return;';
put '%end;';
put '%end;';
put '%put unable to find available fileref in range &prefix.0-&maxtries;';
put '%mend;';
put '%macro mf_getuniquelibref(prefix=mclib,maxtries=1000);';
put '%local x libref;';
put '%let x=0;';
put '%do x=0 %to &maxtries;';
put '%if %sysfunc(libref(&prefix&x)) ne 0 %then %do;';
put '%let libref=&prefix&x;';
put '%let rc=%sysfunc(libname(&libref,%sysfunc(pathname(work))));';
put '%if &rc %then %put %sysfunc(sysmsg());';
put '&prefix&x';
put '%put &sysmacroname: Libref &libref assigned as WORK and returned;';
put '%return;';
put '%end;';
put '%end;';
put '%put unable to find available libref in range &prefix.0-&maxtries;';
put '%mend;';
put '%macro mf_loc(loc);';
put '%let loc=%upcase(&loc);';
put '%local root;';
put '%if &loc=POF or &loc=PLATFORMOBJECTFRAMEWORK %then %do;';
put '%let root=%substr(%sysget(SASROOT),1,%index(%sysget(SASROOT),SASFoundation)-2);';
put '%let root=&root/SASPlatformObjectFramework/&sysver;';
put '%put Batch tools located at: &root;';
put '&root';
put '%end;';
put '%else %if &loc=VIYACONFIG %then %do;';
put '%let root=/opt/sas/viya/config;';
put '%put Viya Config located at: &root;';
put '&root';
put '%end;';
put '%mend;';
put '%macro mv_getapptoken(client_id=someclient';
put ',client_secret=somesecret';
put ',grant_type=authorization_code';
put ');';
put '%local consul_token fname1 fname2 fname3 libref access_token url;';
put '%mp_abort(iftrue=(&grant_type ne authorization_code and &grant_type ne password)';
put ',mac=&sysmacroname';
put ',msg=%str(Invalid value for grant_type: &grant_type)';
put ')';
put 'options noquotelenmax;';
put '/* first, get consul token needed to get client id / secret */';
put 'data _null_;';
put 'infile "%mf_loc(VIYACONFIG)/etc/SASSecurityCertificateFramework/tokens/consul/default/client.token";';
put 'input token:$64.;';
put 'call symputx(''consul_token'',token);';
put 'run;';
put '/* request the client details */';
put '%let fname1=%mf_getuniquefileref();';
put 'proc http method=''POST'' out=&fname1';
put 'url=''/SASLogon/oauth/clients/consul?callback=false&serviceId=app'';';
put 'headers "X-Consul-Token"="&consul_token";';
put 'run;';
put '%let libref=%mf_getuniquelibref();';
put 'libname &libref JSON fileref=&fname1;';
put '/* extract the token */';
put 'data _null_;';
put 'set &libref..root;';
put 'call symputx(''access_token'',access_token);';
put 'run;';
put '%put &=access_token;';
put '%let fname2=%mf_getuniquefileref();';
put 'data _null_;';
put 'file &fname2;';
put 'clientid=quote(trim(symget(''client_id'')));';
put 'clientsecret=quote(trim(symget(''client_secret'')));';
put 'granttype=quote(trim(symget(''grant_type'')));';
put 'put ''{"client_id":'' clientid '',"client_secret":'' clientsecret';
put ''',"scope":["openid","*"],"authorized_grant_types": ['' granttype '',"refresh_token"],''';
put '''"redirect_uri": "urn:ietf:wg:oauth:2.0:oob"}'';';
put 'run;';
put 'data _null_;';
put 'infile &fname2;';
put 'input;';
put 'putlog _infile_;';
put 'run;';
put '%let fname3=%mf_getuniquefileref();';
put 'proc http method=''POST'' in=&fname2 out=&fname3';
put 'url=''/SASLogon/oauth/clients'';';
put 'headers "Content-Type"="application/json"';
put '"Authorization"="Bearer &access_token";';
put 'run;';
put '/* show response */';
put 'data _null_;';
put 'infile &fname3;';
put 'input;';
put 'putlog _infile_;';
put 'run;';
put '/* prepare url */';
put '%if &grant_type=authorization_code %then %do;';
put 'data _null_;';
put 'if symexist(''_baseurl'') then do;';
put 'url=symget(''_baseurl'');';
put 'if subpad(url,length(url)-9,9)=''SASStudio''';
put 'then url=substr(url,1,length(url)-11);';
put 'else url="&systcpiphostname";';
put 'end;';
put 'else url="&systcpiphostname";';
put 'call symputx(''url'',url);';
put 'run;';
put '%end;';
put '%put Please provide the following details to the developer:;';
put '%put ;';
put '%put CLIENT_ID=&client_id;';
put '%put CLIENT_SECRET=&client_secret;';
put '%put GRANT_TYPE=&grant_type;';
put '%put;';
put '%if &grant_type=authorization_code %then %do;';
put '%put NOTE: The developer must also register below and select ''openid'' to get the grant code:;';
put '%put NOTE- ;';
put '%put NOTE- &url/SASLogon/oauth/authorize?client_id=&client_id%str(&)response_type=code;';
put '%put NOTE- ;';
put '%end;';
put '/* clear refs */';
put 'filename &fname1 clear;';
put 'filename &fname2 clear;';
put 'filename &fname3 clear;';
put 'libname &libref clear;';
put '%mend;';
put '* Dependencies end;';
put '* ServiceInit start;';
put '* ServiceInit end;';
put '* Service start;';
put '%let client=client%sysfunc(ranuni(0),hex16.);';
put '%let secret=secret%sysfunc(ranuni(0),hex16.);';
put '%mv_getapptoken(client_id=&client,client_secret=&secret)';
put 'data work.clientinfo;';
put 'client=symget(''client'');';
put 'secret=symget(''secret'');';
put 'run;';
put '%webout(OPEN)';
put '%webout(OBJ,clientinfo)';
put '%webout(CLOSE)';
put '* Service end;';
put '* ServiceTerm start;';
put '* ServiceTerm end;';
run;
%mv_createwebservice(path=&appLoc/&path, name=&service, code=sascode ,replace=yes)
filename sascode clear;
%let path=common;
%let service=getrefreshtoken;
filename sascode temp lrecl=32767;
data _null_;
file sascode;
put '* Service Variables start;';
put '*Service Variables end;';
put '* Dependencies start;';
put '%macro mp_abort(mac=mp_abort.sas, type=, msg=, iftrue=%str(1=1)';
put ')/*/STORE SOURCE*/;';
put '%if not(%eval(%unquote(&iftrue))) %then %return;';
put '%put NOTE: ///  mp_abort macro executing //;';
put '%if %length(&mac)>0 %then %put NOTE- called by &mac;';
put '%put NOTE - &msg;';
put '/* Stored Process Server web app context */';
put '%if %symexist(_metaperson)';
put 'or (%symexist(SYSPROCESSNAME) and "&SYSPROCESSNAME"="Compute Server" )';
put '%then %do;';
put 'options obs=max replace nosyntaxcheck mprint;';
put '/* extract log errs / warns, if exist */';
put '%local logloc logline;';
put '%global logmsg; /* capture global messages */';
put '%if %symexist(SYSPRINTTOLOG) %then %let logloc=&SYSPRINTTOLOG;';
put '%else %let logloc=%qsysfunc(getoption(LOG));';
put 'proc printto log=log;run;';
put '%if %length(&logloc)>0 %then %do;';
put '%let logline=0;';
put 'data _null_;';
put 'infile &logloc lrecl=5000;';
put 'input; putlog _infile_;';
put 'i=1;';
put 'retain logonce 0;';
put 'if (_infile_=:"%str(WARN)ING" or _infile_=:"%str(ERR)OR") and logonce=0 then do;';
put 'call symputx(''logline'',_n_);';
put 'logonce+1;';
put 'end;';
put 'run;';
put '/* capture log including lines BEFORE the err */';
put '%if &logline>0 %then %do;';
put 'data _null_;';
put 'infile &logloc lrecl=5000;';
put 'input;';
put 'i=1;';
put 'stoploop=0;';
put 'if _n_ ge &logline-5 and stoploop=0 then do until (i>12);';
put 'call symputx(''logmsg'',catx(''\n'',symget(''logmsg''),_infile_));';
put 'input;';
put 'i+1;';
put 'stoploop=1;';
put 'end;';
put 'if stoploop=1 then stop;';
put 'run;';
put '%end;';
put '%end;';
put '/* send response in SASjs JSON format */';
put 'data _null_;';
put 'file _webout mod lrecl=32000;';
put 'length msg $32767 debug $8;';
put 'sasdatetime=datetime();';
put 'msg=cats(symget(''msg''),''\n\nLog Extract:\n'',symget(''logmsg''));';
put '/* escape the quotes */';
put 'msg=tranwrd(msg,''"'',''\"'');';
put '/* ditch the CRLFs as chrome complains */';
put 'msg=compress(msg,,''kw'');';
put '/* quote without quoting the quotes (which are escaped instead) */';
put 'msg=cats(''"'',msg,''"'');';
put 'if symexist(''_debug'') then debug=quote(trim(symget(''_debug'')));';
put 'else debug=''""'';';
put 'if debug ge ''"131"'' then put ''>>weboutBEGIN<<'';';
put 'put ''{"START_DTTM" : "'' "%sysfunc(datetime(),datetime20.3)" ''"'';';
put 'put '',"sasjsAbort" : [{'';';
put 'put '' "MSG":'' msg ;';
put 'put '' ,"MAC": "'' "&mac" ''"}]'';';
put 'put ",""SYSUSERID"" : ""&sysuserid"" ";';
put 'put '',"_DEBUG":'' debug ;';
put 'if symexist(''_metauser'') then do;';
put '_METAUSER=quote(trim(symget(''_METAUSER'')));';
put 'put ",""_METAUSER"": " _METAUSER;';
put '_METAPERSON=quote(trim(symget(''_METAPERSON'')));';
put 'put '',"_METAPERSON": '' _METAPERSON;';
put 'end;';
put '_PROGRAM=quote(trim(resolve(symget(''_PROGRAM''))));';
put 'put '',"_PROGRAM" : '' _PROGRAM ;';
put 'put ",""SYSCC"" : ""&syscc"" ";';
put 'put ",""SYSERRORTEXT"" : ""&syserrortext"" ";';
put 'put ",""SYSJOBID"" : ""&sysjobid"" ";';
put 'put ",""SYSWARNINGTEXT"" : ""&syswarningtext"" ";';
put 'put '',"END_DTTM" : "'' "%sysfunc(datetime(),datetime20.3)" ''" '';';
put 'put "}" @;';
put 'if debug ge ''"131"'' then put ''>>weboutEND<<'';';
put 'run;';
put '%let syscc=0;';
put '%if %symexist(SYS_JES_JOB_URI) %then %do;';
put '/* refer web service output to file service in one hit */';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name="_webout.json";';
put '%let rc=%sysfunc(fcopy(_web,_webout));';
put '%end;';
put '%else %if %symexist(_metaport) %then %do;';
put 'data _null_;';
put 'if symexist(''sysprocessmode'')';
put 'then if symget("sysprocessmode")="SAS Stored Process Server"';
put 'then rc=stpsrvset(''program error'', 0);';
put 'run;';
put '%end;';
put '%put _all_;';
put 'filename skip temp;';
put 'data _null_;';
put 'file skip;';
put 'put ''%macro skip(); %macro skippy();'';';
put 'run;';
put '%inc skip;';
put '%end;';
put '%else %do;';
put '%put _all_;';
put '%abort cancel;';
put '%end;';
put '%mend;';
put '%macro mf_getuniquefileref(prefix=mcref,maxtries=1000);';
put '%local x fname;';
put '%let x=0;';
put '%do x=0 %to &maxtries;';
put '%if %sysfunc(fileref(&prefix&x)) > 0 %then %do;';
put '%let fname=&prefix&x;';
put '%let rc=%sysfunc(filename(fname,,temp));';
put '%if &rc %then %put %sysfunc(sysmsg());';
put '&prefix&x';
put '%put &sysmacroname: Fileref &prefix&x was assigned and returned;';
put '%return;';
put '%end;';
put '%end;';
put '%put unable to find available fileref in range &prefix.0-&maxtries;';
put '%mend;';
put '%macro mf_getuniquelibref(prefix=mclib,maxtries=1000);';
put '%local x libref;';
put '%let x=0;';
put '%do x=0 %to &maxtries;';
put '%if %sysfunc(libref(&prefix&x)) ne 0 %then %do;';
put '%let libref=&prefix&x;';
put '%let rc=%sysfunc(libname(&libref,%sysfunc(pathname(work))));';
put '%if &rc %then %put %sysfunc(sysmsg());';
put '&prefix&x';
put '%put &sysmacroname: Libref &libref assigned as WORK and returned;';
put '%return;';
put '%end;';
put '%end;';
put '%put unable to find available libref in range &prefix.0-&maxtries;';
put '%mend;';
put '%macro mv_getrefreshtoken(client_id=someclient';
put ',client_secret=somesecret';
put ',grant_type=authorization_code';
put ',code=';
put ',user=';
put ',pass=';
put ',access_token_var=ACCESS_TOKEN';
put ',refresh_token_var=REFRESH_TOKEN';
put ');';
put '%global &access_token_var &refresh_token_var;';
put '%local fref1 fref2 libref;';
put '/* test the validity of inputs */';
put '%mp_abort(iftrue=(&grant_type ne authorization_code and &grant_type ne password)';
put ',mac=&sysmacroname';
put ',msg=%str(Invalid value for grant_type: &grant_type)';
put ')';
put '%mp_abort(iftrue=(&grant_type=authorization_code and %str(&code)=%str())';
put ',mac=&sysmacroname';
put ',msg=%str(Authorization code required)';
put ')';
put '%mp_abort(iftrue=(&grant_type=password and (%str(&user)=%str() or %str(&pass)=%str()))';
put ',mac=&sysmacroname';
put ',msg=%str(username / password required)';
put ')';
put '%mp_abort(iftrue=(%str(&client)=%str() or %str(&secret)=%str())';
put ',mac=&sysmacroname';
put ',msg=%str(client / secret must both be provided)';
put ')';
put '/* prepare appropriate grant type */';
put '%let fref1=%mf_getuniquefileref();';
put 'data _null_;';
put 'file &fref1;';
put 'if "&grant_type"=''authorization_code'' then string=cats(';
put '''grant_type=authorization_code&code='',symget(''code''));';
put 'else string=cats(''grant_type=password&username='',symget(''user'')';
put ',''&password='',symget(pass));';
put 'call symputx(''grantstring'',cats("''",string,"''"));';
put 'run;';
put '/*data _null_;infile &fref1;input;put _infile_;run;*/';
put '%let fref2=%mf_getuniquefileref();';
put 'proc http method=''POST'' in=&grantstring out=&fref2';
put 'url=''localhost/SASLogon/oauth/token''';
put 'WEBUSERNAME="&client_id"';
put 'WEBPASSWORD="&client_secret"';
put 'AUTH_BASIC;';
put 'headers "Accept"="application/json"';
put '"Content-Type"="application/x-www-form-urlencoded";';
put 'run;';
put '/*data _null_;infile &fref2;input;put _infile_;run;*/';
put '%let libref=%mf_getuniquelibref();';
put 'libname &libref JSON fileref=&fref2;';
put '/* extract the token */';
put 'data _null_;';
put 'set &libref..root;';
put 'call symputx("&access_token_var",access_token);';
put 'call symputx("&refresh_token_var",refresh_token);';
put 'run;';
put '%put NOTE:;';
put '%put NOTE- &access_token_var=&&&access_token_var;';
put '%put NOTE- ;';
put '%put NOTE- &refresh_token_var=&&&refresh_token_var;';
put '%put NOTE- ;';
put 'libname &libref clear;';
put 'filename &fref1 clear;';
put 'filename &fref2 clear;';
put '%mend;';
put '* Dependencies end;';
put '* ServiceInit start;';
put '* ServiceInit end;';
put '* Service start;';
put '%webout(FETCH)';
put 'data _null_;';
put 'set work.fromjs;';
put 'call symputx(''client'',client);';
put 'call symputx(''secret'',secret);';
put 'call symputx(''authcode'',authcode);';
put 'run;';
put '%mv_getrefreshtoken(client_id=&client,client_secret=&secret,code=&authcode)';
put 'data work.tokeninfo;';
put 'set work.fromjs;';
put 'drop authcode;';
put 'access_token="&access_token";';
put 'refresh_token="&refresh_token";';
put 'run;';
put '%webout(OPEN)';
put '%webout(OBJ,tokeninfo)';
put '%webout(CLOSE)';
put '* Service end;';
put '* ServiceTerm start;';
put '* ServiceTerm end;';
run;
%mv_createwebservice(path=&appLoc/&path, name=&service, code=sascode ,replace=yes)
filename sascode clear;
%let path=webv;
%let service=indexjs;
filename sascode temp lrecl=32767;
data _null_;
file sascode;
put '%macro sasjsout(type,fref=sasjs);';
put '%global sysprocessmode SYS_JES_JOB_URI;';
put '%if "&sysprocessmode"="SAS Compute Server" %then %do;';
put '%if &type=HTML %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name="_webout.json"';
put 'contenttype="text/html";';
put '%end;';
put '%else %if &type=JS %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name=''_webout.js''';
put 'contenttype=''application/javascript'';';
put '%end;';
put '%else %if &type=CSS %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name=''_webout.css''';
put 'contenttype=''text/css'';';
put '%end;';
put '%else %if &type=PNG %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name=''_webout.png''';
put 'contenttype=''image/png'' lrecl=2000000 recfm=n;';
put '%end;';
put '%else %if &type=MP3 %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name=''_webout.mp3''';
put 'contenttype=''audio/mpeg'' lrecl=2000000 recfm=n;';
put '%end;';
put '%end;';
put '%else %do;';
put '%if &type=JS %then %do;';
put '%let rc=%sysfunc(stpsrv_header(Content-type,application/javascript));';
put '%end;';
put '%else %if &type=CSS %then %do;';
put '%let rc=%sysfunc(stpsrv_header(Content-type,text/css));';
put '%end;';
put '%else %if &type=PNG %then %do;';
put '%let rc=%sysfunc(stpsrv_header(Content-type,image/png));';
put '%end;';
put '%else %if &type=MP3 %then %do;';
put '%let rc=%sysfunc(stpsrv_header(Content-type,audio/mpeg));';
put '%end;';
put '%end;';
put '%if &type=HTML %then %do;';
put 'filename _sjs temp;';
put 'data _null_;';
put 'file _sjs lrecl=32767 encoding=''utf-8'';';
put 'infile &fref lrecl=32767;';
put 'input;';
put 'if find(_infile_,'' appLoc: '') then do;';
put 'pgm="&_program";';
put 'rootlen=length(trim(pgm))-length(scan(pgm,-1,''/''))-1;';
put 'root=quote(substr(pgm,1,rootlen));';
put 'put ''    appLoc: '' root '','';';
put 'end;';
put 'else if find(_infile_,'' serverType: '') then do;';
put 'if symexist(''_metaperson'') then put ''    serverType: "SAS9" ,'';';
put 'else put ''    serverType: "SASVIYA" ,'';';
put 'end;';
put 'else if find(_infile_,'' hostUrl: '') then do;';
put '/* nothing - we are streaming so this will default to hostname */';
put 'end;';
put 'else put _infile_;';
put 'run;';
put '%let fref=_sjs;';
put '%end;';
put '/* stream byte by byte */';
put '%if &type=PNG or &type=MP3 %then %do;';
put 'data _null_;';
put 'length filein 8 fileout 8;';
put 'filein = fopen("&fref",''I'',4,''B'');';
put 'fileout = fopen("_webout",''A'',1,''B'');';
put 'char= ''20''x;';
put 'do while(fread(filein)=0);';
put 'raw="1234";';
put 'do i=1 to 4;';
put 'rc=fget(filein,char,1);';
put 'substr(raw,i,1)=char;';
put 'end;';
put 'val="123";';
put 'val=input(raw,$base64X4.);';
put 'do i=1 to 3;';
put 'length byte $1;';
put 'byte=byte(rank(substr(val,i,1)));';
put 'rc = fput(fileout, byte);';
put 'end;';
put 'rc =fwrite(fileout);';
put 'end;';
put 'rc = fclose(filein);';
put 'rc = fclose(fileout);';
put 'run;';
put '%end;';
put '%else %do;';
put 'data _null_;';
put 'length filein 8 fileid 8;';
put 'filein = fopen("&fref",''I'',1,''B'');';
put 'fileid = fopen("_webout",''A'',1,''B'');';
put 'rec = ''20''x;';
put 'do while(fread(filein)=0);';
put 'rc = fget(filein,rec,1);';
put 'rc = fput(fileid, rec);';
put 'rc =fwrite(fileid);';
put 'end;';
put 'rc = fclose(filein);';
put 'rc = fclose(fileid);';
put 'run;';
put '%end;';
put '%mend;';
put 'filename sasjs temp lrecl=99999999;';
put 'data _null_;';
put 'file sasjs;';
put 'put ''!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.SASjs=t():e.SASjs=t()}(window,function(){return n={}''@;';
put 'put '',i.m=r=[function(e,t,r){"use strict";var w=this&&this.__assign||function(){return(w=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i''@;';
put 'put '')&&(e[i]=t[i]);return e}).apply(this,arguments)},_=this&&this.__awaiter||function(e,s,u,a){return new(u=u||Promise)(function(r,t){function n(e){try{o(a.next(e))}catch(e){t(e)}}function i(e){try{o(a.throw(e))}catch(e){t(e''@;';
put 'put '')}}function o(e){var t;e.done?r(e.value):((t=e.value)instanceof u?t:new u(function(e){e(t)})).then(n,i)}o((a=a.apply(e,s||[])).next())})},A=this&&this.__generator||function(r,n){var i,o,s,e,u={label:0,sent:function(){if(''@;';
put 'put ''1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(''@;';
put 'put ''i)throw new TypeError("Generator is already executing.");for(;u;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[''@;';
put 'put ''0]){case 0:case 1:s=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,o=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(s=0<(s=u.trys).length&&s[s.length-1])&&(6===t[0]||2=''@;';
put 'put ''==t[0])){u=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){u.label=t[1];break}if(6===t[0]&&u.label<s[1]){u.label=s[1],s=t;break}if(s&&u.label<s[2]){u.label=s[2],u.ops.push(t);break}s[2]&&u.ops.pop(),u.trys.pop();cont''@;';
put 'put ''inue}t=n.call(r,u)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.SASjsConfig=void 0,r(1),r(3).polyfill();var ''@;';
put 'put ''n=function(){this.serverUrl="",this.pathSAS9="",this.pathSASViya="",this.appLoc="",this.serverType="",this.debug=!0};t.SASjsConfig=n;var o={serverUrl:"",pathSAS9:"/SASStoredProcess/do",pathSASViya:"/SASJobExecution",appL''@;';
put 'put ''oc:"/Public/seedapp",serverType:"SASVIYA",debug:!0},i=(s.prototype.getSasjsConfig=function(){return this.sasjsConfig},s.prototype.getUserName=function(){return this.userName},s.prototype.getCsrf=function(){return this._c''@;';
put 'put ''srf},s.prototype.setSASjsConfig=function(e){this.sasjsConfig=w(w({},this.sasjsConfig),e),this.setupConfiguration()},s.prototype.setDebugState=function(e){this.sasjsConfig.debug=e},s.prototype.checkSession=function(){retu''@;';
put 'put ''rn _(this,void 0,void 0,function(){var t,r;return A(this,function(e){switch(e.label){case 0:return[4,fetch(this.loginUrl)];case 1:return[4,e.sent().text()];case 2:return t=e.sent(),r=this.isLogInRequired(t),[2,Promise.re''@;';
put 'put ''solve({isLoggedIn:!r,userName:this.userName})]}})})},s.prototype.logIn=function(u,a){return _(this,void 0,void 0,function(){var t,r,n,i,o,s=this;return A(this,function(e){switch(e.label){case 0:return t={_service:"defaul''@;';
put 'put ''t",username:u,password:a},this.userName=t.username,[4,this.checkSession()];case 1:return(r=e.sent().isLoggedIn)?(this.resendWaitingRequests(),[2,Promise.resolve({isLoggedIn:r,userName:this.userName})]):[4,this.getLoginFo''@;';
put 'put ''rm()];case 2:for(i in n=e.sent())t[i]=n[i];return o=function(e){var t=[];for(var r in e)if(e.hasOwnProperty(r))if(e[r]instanceof Array)for(var n=0,i=e[r].length;n<i;n++)t.push(encodeURIComponent(r)+"="+encodeURIComponent''@;';
put 'put ''(e[r][n]));else t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")}(t),[2,fetch(this.loginUrl,{method:"post",credentials:"include",referrerPolicy:"same-origin",body:o,headers:new Headers({"Cont''@;';
put 'put ''ent-Type":"application/x-www-form-urlencoded"})}).then(function(e){return e.text()}).then(function(n){return _(s,void 0,void 0,function(){var t,r;return A(this,function(e){switch(e.label){case 0:return this.isAuthorizeFo''@;';
put 'put ''rmRequired(n)?[4,this.parseAndSubmitAuthorizeForm(n)]:[3,2];case 1:return t=e.sent(),r=t.includes("Authentication success, retry original request"),[3,3];case 2:r=(r=this.isLogInSuccess(n))||!this.isLogInRequired(n),e.la''@;';
put 'put ''bel=3;case 3:return r&&this.resendWaitingRequests(),[2,{isLoggedIn:r,userName:this.userName}]}})})}).catch(function(e){return Promise.reject(e)})]}})})},s.prototype.logOut=function(){var n=this;return new Promise(functio''@;';
put 'put ''n(e,t){var r=""+n.serverUrl+n.logoutUrl;fetch(r).then(function(){e(!0)}).catch(function(e){return t(e)})})},s.prototype.request=function(m,g,b,S){return _(this,void 0,void 0,function(){var o,t,r,s,u,a,c,n,i,f,l,h,p,d,y,v''@;';
put 'put ''=this;return A(this,function(e){if(o=this.appLoc?this.appLoc.replace(/\/?$/,"/")+m.replace(/^\//,""):m,t=""+this.serverUrl+this.jobsPath+"/?_program="+o,r=w(w({},b||{}),this.getRequestParams()),s=this,u=new FormData,a=!1''@;';
put 'put '',c="",g)if("SAS9"===this.sasjsConfig.serverType)for(l in g){if(a)return[2];"ERROR: LARGE STRING LENGTH"===(h=T(g[n=l]))&&(a=!0,c="The max length of a string value in SASjs is 32765 characters."),u.append(n,new Blob([h],{''@;';
put 'put ''type:"application/csv"}),n+".csv")}else{for(l in i=[],f=0,g){if(a)return[2];f++,i.push(l),"ERROR: LARGE STRING LENGTH"===(h=T(g[l]))&&(a=!0,c="The max length of a string value in SASjs is 32765 characters."),16e3<h.lengt''@;';
put 'put ''h?j(h).map(function(e){u.append("sasjs"+f+"data",e)}):r["sasjs"+f+"data"]=h}r.sasjs_tables=i.join(" ")}for(p in r)r.hasOwnProperty(p)&&u.append(p,r[p]);return y=!(d={requestPromise:{promise:null,resolve:null,reject:null}''@;';
put 'put '',programName:m,data:g,params:b}),d.requestPromise.promise=new Promise(function(n,i){a&&i({MESSAGE:c}),fetch(t,{method:"POST",body:u,referrerPolicy:"same-origin"}).then(function(n){return _(v,void 0,void 0,function(){var ''@;';
put 'put ''t,r;return A(this,function(e){return n.ok||403===n.status&&(t=n.headers.get("X-CSRF-HEADER"))&&(r=n.headers.get(t),this._csrf=r),n.redirected&&"SAS9"===this.sasjsConfig.serverType&&(y=!0),[2,n.text()]})})}).then(function''@;';
put 'put ''(t){if(!v.needsRetry(t)&&!y||v.isLogInRequired(t))if(v.retryCount=0,v.parseLogFromResponse(t,o),s.isLogInRequired(t))S&&S(!0),d.requestPromise.resolve=n,d.requestPromise.reject=i,v.sasjsWaitingRequests.push(d);else if("S''@;';
put 'put ''AS9"===v.sasjsConfig.serverType&&v.sasjsConfig.debug){v.updateUsername(t);var e=v.parseSAS9Response(t);""!==e?n(JSON.parse(e)):i({MESSAGE:v.parseSAS9ErrorResponse(t)})}else if("SASVIYA"===v.sasjsConfig.serverType&&v.sasj''@;';
put 'put ''sConfig.debug)try{v.parseSASVIYADebugResponse(t).then(function(t){v.updateUsername(t);try{n(JSON.parse(t))}catch(e){i({MESSAGE:t})}},function(e){i({MESSAGE:e})})}catch(e){i({MESSAGE:t})}else{v.updateUsername(t);try{var r''@;';
put 'put ''=JSON.parse(t);n(r)}catch(e){i({MESSAGE:t})}}else v.retryCount<v.retryLimit?(v.retryCount++,v.request(m,g,b).then(function(e){return n(e)},function(e){return i(e)})):(v.retryCount=0,i(t))}).catch(function(e){i(e)})}),[2,''@;';
put 'put ''d.requestPromise.promise]})})},s.prototype.resendWaitingRequests=function(){return _(this,void 0,void 0,function(){var t,r,n,i,o;return A(this,function(e){for(t=function(t){r.request(t.programName,t.data,t.params).then(f''@;';
put 'put ''unction(e){t.requestPromise.resolve(e)},function(e){t.requestPromise.reject(e)})},n=0,i=(r=this).sasjsWaitingRequests;n<i.length;n++)o=i[n],t(o);return this.sasjsWaitingRequests=[],[2]})})},s.prototype.needsRetry=functio''@;';
put 'put ''n(e){return e.includes(''''"errorCode":403'''')&&e.includes("_csrf")&&e.includes("X-CSRF-TOKEN")||e.includes(''''"status":403'''')&&e.includes(''''"error":"Forbidden"'''')||e.includes(''''"status":449'''')&&e.includes("Authentication success, r''@;';
put 'put ''etry original request")},s.prototype.getRequestParams=function(){var e={};return this._csrf&&(e._csrf=this._csrf),this.sasjsConfig.debug&&(e._omittextlog="false",e._omitsessionresults="false",e._debug=131),e},s.prototype''@;';
put 'put ''.updateUsername=function(e){try{var t=JSON.parse(e);"SAS9"===this.sasjsConfig.serverType?this.userName=t._METAUSER:this.userName=t.SYSUSERID}catch(e){this.userName=""}},s.prototype.parseSASVIYADebugResponse=function(i){v''@;';
put 'put ''ar o=this;return new Promise(function(t,e){var r=i.split(''''<iframe style="width: 99%; height: 500px" src="'''')[1],n=r?r.split(''''"></iframe>'''')[0]:null;n?fetch(o.serverUrl+n).then(function(e){return e.text()}).then(function(e)''@;';
put 'put ''{t(e)}):e("No debug info in response")})},s.prototype.parseSAS9Response=function(e){var t="";if(e.includes(">>weboutBEGIN<<"))try{t=e.split(">>weboutBEGIN<<")[1].split(">>weboutEND<<")[0]}catch(e){t="",console.error(e)}r''@;';
put 'put ''eturn t},s.prototype.parseSAS9ErrorResponse=function(e){var t=e.split("\n"),r=[],n=-1;t.map(function(e,t){e.toLowerCase().includes("error")&&!e.toLowerCase().includes("this request completed with errors.")&&-1===n&&(n=t)''@;';
put 'put ''});for(var i=n-10;i<=n+10;i++)r.push(t[i]);return r.join(", ")},s.prototype.parseLogFromResponse=function(e,t){"SAS9"===this.sasjsConfig.serverType||this.sasjsConfig.debug?this.appendSasjsRequest(e,t,null):this.appendSas''@;';
put 'put ''jsRequest(null,t,null)},s.prototype.fetchLogFileContent=function(e){return new Promise(function(t,r){fetch(e,{method:"GET"}).then(function(e){return e.text()}).then(function(e){return t(e)}).catch(function(e){return r(e)''@;';
put 'put ''})})},s.prototype.appendSasjsRequest=function(i,o,e){return _(this,void 0,void 0,function(){var t,r,n;return A(this,function(e){switch(e.label){case 0:return r=t="",n=null,i?(t=this.parseSourceCode(i),r=this.parseGenerat''@;';
put 'put ''edCode(i),[4,this.parseSasWork(i)]):[3,2];case 1:n=e.sent(),e.label=2;case 2:return this.sasjsRequests.push({logFile:i,serviceLink:o,timestamp:new Date,sourceCode:t,generatedCode:r,SASWORK:n}),20<this.sasjsRequests.lengt''@;';
put 'put ''h&&this.sasjsRequests.splice(0,1),[2]}})})},s.prototype.parseSasWork=function(r){return _(this,void 0,void 0,function(){var t;return A(this,function(e){switch(e.label){case 0:if(!this.sasjsConfig.debug)return[3,4];if("SA''@;';
put 'put ''S9"!==this.sasjsConfig.serverType)return[3,1];try{t=JSON.parse(this.parseSAS9Response(r))}catch(e){}return[3,3];case 1:return[4,this.parseSASVIYADebugResponse(r).then(function(e){try{t=JSON.parse(e)}catch(e){}},function(''@;';
put 'put ''e){console.log(e)})];case 2:e.sent(),e.label=3;case 3:if(t)return[2,t.WORK];e.label=4;case 4:return[2,null]}})})},s.prototype.parseSourceCode=function(e){return e.split("\n").filter(function(e){return e.trim().substring(''@;';
put 'put ''0,10).trimStart().match(/^\d/)}).join("\r\n")},s.prototype.parseGeneratedCode=function(e){return e.split("\n").filter(function(e){return e.trim().startsWith("MPRINT")}).join("\r\n")},s.prototype.getSasRequests=function()''@;';
put 'put ''{return this.sasjsRequests.sort(u)},s.prototype.setupConfiguration=function(){if(void 0===this.sasjsConfig.serverUrl||""===this.sasjsConfig.serverUrl){var e=location.protocol+"//"+location.hostname;location.port&&(e=e+":''@;';
put 'put ''"+location.port),this.sasjsConfig.serverUrl=e}"/"===this.sasjsConfig.serverUrl.slice(-1)&&(this.sasjsConfig.serverUrl=this.sasjsConfig.serverUrl.slice(0,-1)),this.serverUrl=this.sasjsConfig.serverUrl,this.jobsPath="SASVI''@;';
put 'put ''YA"===this.sasjsConfig.serverType?this.sasjsConfig.pathSASViya:this.sasjsConfig.pathSAS9,this.appLoc=this.sasjsConfig.appLoc,this.loginUrl=this.serverUrl+"/SASLogon/login",this.logoutUrl="SAS9"===this.sasjsConfig.serverT''@;';
put 'put ''ype?"/SASLogon/logout?":"/SASLogon/logout.do?"},s.prototype.isAuthorizeFormRequired=function(e){return/<form.+action="(.*Logon\/oauth\/authorize[^"]*).*>/gm.test(e)},s.prototype.parseAndSubmitAuthorizeForm=function(h){re''@;';
put 'put ''turn _(this,void 0,void 0,function(){var r,t,n,i,o,s,u,a,c,f,l;return A(this,function(e){for(t={},n=h.split("<body>")[1].split("</body>")[0],(i=document.createElement("div")).innerHTML=n,o=i.querySelector("#application_a''@;';
put 'put ''uthorization"),r=o?this.sasjsConfig.serverUrl+o.getAttribute("action"):null,s=null==o?void 0:o.querySelectorAll("input"),u=0,a=s;u<a.length;u++)"user_oauth_approval"===(c=a[u]).name&&(c.value="true"),t[c.name]=c.value;fo''@;';
put 'put ''r(l in f=new FormData,t)t.hasOwnProperty(l)&&f.append(l,t[l]);return[2,new Promise(function(t,e){r?fetch(r,{method:"POST",credentials:"include",body:f,referrerPolicy:"same-origin"}).then(function(e){return e.text()}).the''@;';
put 'put ''n(function(e){t(e)}):e("Auth form url is null")})]})})},s.prototype.getLoginForm=function(){return _(this,void 0,void 0,function(){var t,r,n,i,o;return A(this,function(e){switch(e.label){case 0:return t=/<form.+action="(''@;';
put 'put ''.*Logon[^"]*).*>/,[4,fetch(this.loginUrl).then(function(e){return e.text()})];case 1:return r=e.sent(),n=t.exec(r),i={},n&&n.length&&(this.setLoginUrl(n),(o=r.match(/<input.*"hidden"[^>]*>/g))&&o.forEach(function(e){var ''@;';
put 'put ''t=e.match(/name="([^"]*)"\svalue="([^"]*)/);t&&t.length&&(i[t[1]]=t[2])})),[2,Object.keys(i).length?i:null]}})})},s);function s(e){var i=this;this.sasjsConfig=new n,this.serverUrl="",this.jobsPath="",this.appLoc="",this.''@;';
put 'put ''logoutUrl="",this.loginUrl="",this._csrf=null,this.retryCount=0,this.retryLimit=5,this.sasjsRequests=[],this.sasjsWaitingRequests=[],this.userName="",this.setLoginUrl=function(e){var t=e[1].replace(/\?.*/,"");if("/"===t[''@;';
put 'put ''0]){t=t.substr(1);var r=i.serverUrl?i.serverUrl+"/"+t:""+t,n=r;"SAS9"===i.sasjsConfig.serverType&&(n=i.getSas9LoginUrl(r)),i.loginUrl=n}},this.getSas9LoginUrl=function(e){var t=e.split("."),r=t.indexOf("do");return-1<r&&''@;';
put 'put ''t.splice(r,1),t.join(".")},this.isLogInSuccess=function(e){return/You have signed in/gm.test(e)},this.isLogInRequired=function(e){return/<form.+action="(.*Logon[^"]*).*>/gm.test(e)},this.sasjsConfig=w(w({},o),e),this.set''@;';
put 'put ''upConfiguration()}t.default=i;var u=function(e,t){return t.timestamp.getTime()-e.timestamp.getTime()};function j(e){for(var t=Math.ceil(e.length/16e3),r=new Array(t),n=0,i=0;n<t;++n,i+=16e3)r[n]=e.substr(i,16e3);return r''@;';
put 'put ''}function T(t){function s(e,t){return null===t?"":t}var e,r=Object.keys(t[0]),n=!1,u=r.map(function(o){var s=null,u=!1,a=-1,e=t.map(function(e,t){if(e[o]||""===e[o]){if(s){var r=""===e[o]||"string"==typeof e[o]?"chars":"''@;';
put 'put ''number";u||(a=(u=r!==s)?t+1:-1)}else s=""===e[o]||"string"==typeof e[o]?"chars":"number";var n=void 0;if("string"==typeof e[o]){var i=e[o].split("").filter(function(e){return''''"''''===e});n=function(e){for(var t=e.length,r=e''@;';
put 'put ''.length-1;0<=r;r--){var n=e.charCodeAt(r);127<n&&n<=2047?t++:2047<n&&n<=65535&&(t+=2),56320<=n&&n<=57343&&r--}return t}(e[o]),0<i.length&&(n+=i.length)}return n}}).sort(function(e,t){return t-e})[0];return e&&32765<e&&(n''@;';
put 'put ''=!0),u&&console.error("Row ("+a+"), Column ("+o+") has mixed types: ERROR"),o+":"+("chars"===s?"$":"")+(e||("chars"===s?"1":"best"))+"."});return n?"ERROR: LARGE STRING LENGTH":(e=t.map(function(o){return Object.keys(o).''@;';
put 'put ''map(function(e,t){var r,n=!1,i=o[e];return-1<JSON.stringify(i).search(/(\\t|\\n|\\r)/gm)?(r=i.toString(),n=!0):r=JSON.stringify(i,s),r=r.replace(/\\\\/gm,"\\"),n?(r.includes(",")||r.includes(''''"''''))&&(r=''''"''''+r+''''"''''):(r.inclu''@;';
put 'put ''des(",")||!r.includes(''''"'''')||r.includes(''''\\"'''')||(r=r.substring(1,r.length-1)),r=r.replace(/\\"/gm,''''""'''')),""===(r=r.replace(/\r\n/gm,"\n"))&&u[t].includes("best")&&(r="."),r}).join(",")}),u.join(",").replace(/,/g," ")+"\r\''@;';
put 'put ''n"+e.join("\r\n"))}},function(e,t,r){r(2),e.exports=self.fetch.bind(self)},function(e,t,r){"use strict";r.r(t),r.d(t,"Headers",function(){return c}),r.d(t,"Request",function(){return v}),r.d(t,"Response",function(){retur''@;';
put 'put ''n g}),r.d(t,"DOMException",function(){return S}),r.d(t,"fetch",function(){return w});var u={searchParams:"URLSearchParams"in self,iterable:"Symbol"in self&&"iterator"in Symbol,blob:"FileReader"in self&&"Blob"in self&&fun''@;';
put 'put ''ction(){try{return new Blob,!0}catch(e){return!1}}(),formData:"FormData"in self,arrayBuffer:"ArrayBuffer"in self};if(u.arrayBuffer)var n=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object I''@;';
put 'put ''nt16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],i=ArrayBuffer.isView||function(e){return e&&-1<n.indexOf(Object.prototype.toString.call(e))''@;';
put 'put ''};function o(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&''''*+.^_`|~]/i.test(e))throw new TypeError("Invalid character in header field name");return e.toLowerCase()}function s(e){return"string"!=typeof e&&(e=Str''@;';
put 'put ''ing(e)),e}function a(t){var e={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return u.iterable&&(e[Symbol.iterator]=function(){return e}),e}function c(t){this.map={},t instanceof c?t.forEach(function(''@;';
put 'put ''e,t){this.append(t,e)},this):Array.isArray(t)?t.forEach(function(e){this.append(e[0],e[1])},this):t&&Object.getOwnPropertyNames(t).forEach(function(e){this.append(e,t[e])},this)}function f(e){if(e.bodyUsed)return Promise''@;';
put 'put ''.reject(new TypeError("Already read"));e.bodyUsed=!0}function l(r){return new Promise(function(e,t){r.onload=function(){e(r.result)},r.onerror=function(){t(r.error)}})}function h(e){var t=new FileReader,r=l(t);return t.r''@;';
put 'put ''eadAsArrayBuffer(e),r}function p(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function d(){return this.bodyUsed=!1,this._initBody=function(e){var t;(this._bo''@;';
put 'put ''dyInit=e)?"string"==typeof e?this._bodyText=e:u.blob&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:u.formData&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:u.searchParams&&URLSearchParams.prototype.isProt''@;';
put 'put ''otypeOf(e)?this._bodyText=e.toString():u.arrayBuffer&&u.blob&&((t=e)&&DataView.prototype.isPrototypeOf(t))?(this._bodyArrayBuffer=p(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):u.arrayBuffer&&(ArrayBuffer.''@;';
put 'put ''prototype.isPrototypeOf(e)||i(e))?this._bodyArrayBuffer=p(e):this._bodyText=e=Object.prototype.toString.call(e):this._bodyText="",this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","tex''@;';
put 'put ''t/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):u.searchParams&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-''@;';
put 'put ''www-form-urlencoded;charset=UTF-8"))},u.blob&&(this.blob=function(){var e=f(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bod''@;';
put 'put ''yArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?f(this)||Promise.''@;';
put 'put ''resolve(this._bodyArrayBuffer):this.blob().then(h)}),this.text=function(){var e,t,r,n=f(this);if(n)return n;if(this._bodyBlob)return e=this._bodyBlob,t=new FileReader,r=l(t),t.readAsText(e),r;if(this._bodyArrayBuffer)ret''@;';
put 'put ''urn Promise.resolve(function(e){for(var t=new Uint8Array(e),r=new Array(t.length),n=0;n<t.length;n++)r[n]=String.fromCharCode(t[n]);return r.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could ''@;';
put 'put ''not read FormData body as text");return Promise.resolve(this._bodyText)},u.formData&&(this.formData=function(){return this.text().then(m)}),this.json=function(){return this.text().then(JSON.parse)},this}c.prototype.appen''@;';
put 'put ''d=function(e,t){e=o(e),t=s(t);var r=this.map[e];this.map[e]=r?r+", "+t:t},c.prototype.delete=function(e){delete this.map[o(e)]},c.prototype.get=function(e){return e=o(e),this.has(e)?this.map[e]:null},c.prototype.has=func''@;';
put 'put ''tion(e){return this.map.hasOwnProperty(o(e))},c.prototype.set=function(e,t){this.map[o(e)]=s(t)},c.prototype.forEach=function(e,t){for(var r in this.map)this.map.hasOwnProperty(r)&&e.call(t,this.map[r],r,this)},c.prototy''@;';
put 'put ''pe.keys=function(){var r=[];return this.forEach(function(e,t){r.push(t)}),a(r)},c.prototype.values=function(){var t=[];return this.forEach(function(e){t.push(e)}),a(t)},c.prototype.entries=function(){var r=[];return this''@;';
put 'put ''.forEach(function(e,t){r.push([t,e])}),a(r)},u.iterable&&(c.prototype[Symbol.iterator]=c.prototype.entries);var y=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function v(e,t){var r,n,i=(t=t||{}).body;if(e instanceof v)''@;';
put 'put ''{if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new c(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,i||null==e._bodyInit|''@;';
put 'put ''|(i=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",!t.headers&&this.headers||(this.headers=new c(t.headers)),this.method=(r=t.method||this.method||"G''@;';
put 'put ''ET",n=r.toUpperCase(),-1<y.indexOf(n)?n:r),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&i)throw new TypeError("Body not allowed for G''@;';
put 'put ''ET or HEAD requests");this._initBody(i)}function m(e){var i=new FormData;return e.trim().split("&").forEach(function(e){if(e){var t=e.split("="),r=t.shift().replace(/\+/g," "),n=t.join("=").replace(/\+/g," ");i.append(de''@;';
put 'put ''codeURIComponent(r),decodeURIComponent(n))}}),i}function g(e,t){t=t||{},this.type="default",this.status=void 0===t.status?200:t.status,this.ok=200<=this.status&&this.status<300,this.statusText="statusText"in t?t.statusTe''@;';
put 'put ''xt:"OK",this.headers=new c(t.headers),this.url=t.url||"",this._initBody(e)}v.prototype.clone=function(){return new v(this,{body:this._bodyInit})},d.call(v.prototype),d.call(g.prototype),g.prototype.clone=function(){retur''@;';
put 'put ''n new g(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new c(this.headers),url:this.url})},g.error=function(){var e=new g(null,{status:0,statusText:""});return e.type="error",e};var b=[301,302,303,''@;';
put 'put ''307,308];g.redirect=function(e,t){if(-1===b.indexOf(t))throw new RangeError("Invalid status code");return new g(null,{status:t,headers:{location:e}})};var S=self.DOMException;try{new S}catch(e){(S=function(e,t){this.mess''@;';
put 'put ''age=e,this.name=t;var r=Error(e);this.stack=r.stack}).prototype=Object.create(Error.prototype),S.prototype.constructor=S}function w(i,s){return new Promise(function(n,e){var t=new v(i,s);if(t.signal&&t.signal.aborted)ret''@;';
put 'put ''urn e(new S("Aborted","AbortError"));var o=new XMLHttpRequest;function r(){o.abort()}o.onload=function(){var e,i,t={status:o.status,statusText:o.statusText,headers:(e=o.getAllResponseHeaders()||"",i=new c,e.replace(/\r?\''@;';
put 'put ''n[\t ]+/g," ").split(/\r?\n/).forEach(function(e){var t=e.split(":"),r=t.shift().trim();if(r){var n=t.join(":").trim();i.append(r,n)}}),i)};t.url="responseURL"in o?o.responseURL:t.headers.get("X-Request-URL");var r="resp''@;';
put 'put ''onse"in o?o.response:o.responseText;n(new g(r,t))},o.onerror=function(){e(new TypeError("Network request failed"))},o.ontimeout=function(){e(new TypeError("Network request failed"))},o.onabort=function(){e(new S("Aborted''@;';
put 'put ''","AbortError"))},o.open(t.method,t.url,!0),"include"===t.credentials?o.withCredentials=!0:"omit"===t.credentials&&(o.withCredentials=!1),"responseType"in o&&u.blob&&(o.responseType="blob"),t.headers.forEach(function(e,t''@;';
put 'put ''){o.setRequestHeader(t,e)}),t.signal&&(t.signal.addEventListener("abort",r),o.onreadystatechange=function(){4===o.readyState&&t.signal.removeEventListener("abort",r)}),o.send(void 0===t._bodyInit?null:t._bodyInit)})}w.po''@;';
put 'put ''lyfill=!0,self.fetch||(self.fetch=w,self.Headers=c,self.Request=v,self.Response=g)},function(e,t,r){(function(ne,ie){'';';
put 'put ''/*!'';';
put 'put '' * @overview es6-promise - a tiny implementation of Promises/A+.'';';
put 'put '' * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)'';';
put 'put '' * @license   Licensed under MIT license'';';
put 'put '' *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE'';';
put 'put '' * @version   v4.2.8+1e68dce6'';';
put 'put '' */'';';
put 'put ''e.exports=function(){"use strict";function n(e){var t=typeof e;return e!==null&&(t==="object"||t==="function")}function a(e){return typeof e==="function"}var e=void 0;if(Array.isArray){e=Array.isArray}else{e=function(e){''@;';
put 'put ''return Object.prototype.toString.call(e)==="[object Array]"}}var r=e,i=0,t=void 0,o=void 0,s=function e(t,r){S[i]=t;S[i+1]=r;i+=2;if(i===2){if(o){o(w)}else{A()}}};function u(e){o=e}function c(e){s=e}var f=typeof window!=''@;';
put 'put ''="undefined"?window:undefined,l=f||{},h=l.MutationObserver||l.WebKitMutationObserver,p=typeof self==="undefined"&&typeof ne!=="undefined"&&{}.toString.call(ne)==="[object process]",d=typeof Uint8ClampedArray!=="undefined''@;';
put 'put ''"&&typeof importScripts!=="undefined"&&typeof MessageChannel!=="undefined";function y(){return function(){return ne.nextTick(w)}}function v(){if(typeof t!=="undefined"){return function(){t(w)}}return b()}function m(){var''@;';
put 'put '' e=0;var t=new h(w);var r=document.createTextNode("");t.observe(r,{characterData:true});return function(){r.data=e=++e%2}}function g(){var e=new MessageChannel;e.port1.onmessage=w;return function(){return e.port2.postMes''@;';
put 'put ''sage(0)}}function b(){var e=setTimeout;return function(){return e(w,1)}}var S=new Array(1e3);function w(){for(var e=0;e<i;e+=2){var t=S[e];var r=S[e+1];t(r);S[e]=undefined;S[e+1]=undefined}i=0}function _(){try{var e=Func''@;';
put 'put ''tion("return this")().require("vertx");t=e.runOnLoop||e.runOnContext;return v()}catch(e){return b()}}var A=void 0;if(p){A=y()}else if(h){A=m()}else if(d){A=g()}else if(f===undefined&&"function"==="function"){A=_()}else{A''@;';
put 'put ''=b()}function j(e,t){var r=this;var n=new this.constructor(R);if(n[E]===undefined){J(n)}var i=r._state;if(i){var o=arguments[i-1];s(function(){return H(i,n,o,r._result)})}else{M(r,n,e,t)}return n}function T(e){var t=this''@;';
put 'put '';if(e&&typeof e==="object"&&e.constructor===t){return e}var r=new t(R);B(r,e);return r}var E=Math.random().toString(36).substring(2);function R(){}var C=void 0,P=1,x=2;function O(){return new TypeError("You cannot resolv''@;';
put 'put ''e a promise with itself")}function U(){return new TypeError("A promises callback cannot return that same promise.")}function L(e,t,r,n){try{e.call(t,r,n)}catch(e){return e}}function q(e,n,i){s(function(t){var r=false;var''@;';
put 'put '' e=L(i,n,function(e){if(r){return}r=true;if(n!==e){B(t,e)}else{D(t,e)}},function(e){if(r){return}r=true;G(t,e)},"Settle: "+(t._label||" unknown promise"));if(!r&&e){r=true;G(t,e)}},e)}function I(t,e){if(e._state===P){D(t''@;';
put 'put '',e._result)}else if(e._state===x){G(t,e._result)}else{M(e,undefined,function(e){return B(t,e)},function(e){return G(t,e)})}}function N(e,t,r){if(t.constructor===e.constructor&&r===j&&t.constructor.resolve===T){I(e,t)}els''@;';
put 'put ''e{if(r===undefined){D(e,t)}else if(a(r)){q(e,t,r)}else{D(e,t)}}}function B(t,e){if(t===e){G(t,O())}else if(n(e)){var r=void 0;try{r=e.then}catch(e){G(t,e);return}N(t,e,r)}else{D(t,e)}}function F(e){if(e._onerror){e._oner''@;';
put 'put ''ror(e._result)}k(e)}function D(e,t){if(e._state!==C){return}e._result=t;e._state=P;if(e._subscribers.length!==0){s(k,e)}}function G(e,t){if(e._state!==C){return}e._state=x;e._result=t;s(F,e)}function M(e,t,r,n){var i=e._''@;';
put 'put ''subscribers;var o=i.length;e._onerror=null;i[o]=t;i[o+P]=r;i[o+x]=n;if(o===0&&e._state){s(k,e)}}function k(e){var t=e._subscribers;var r=e._state;if(t.length===0){return}var n=void 0,i=void 0,o=e._result;for(var s=0;s<t.''@;';
put 'put ''length;s+=3){n=t[s];i=t[s+r];if(n){H(r,n,i,o)}else{i(o)}}e._subscribers.length=0}function H(e,t,r,n){var i=a(r),o=void 0,s=void 0,u=true;if(i){try{o=r(n)}catch(e){u=false;s=e}if(t===o){G(t,U());return}}else{o=n}if(t._sta''@;';
put 'put ''te!==C){}else if(i&&u){B(t,o)}else if(u===false){G(t,s)}else if(e===P){D(t,o)}else if(e===x){G(t,o)}}function W(r,e){try{e(function e(t){B(r,t)},function e(t){G(r,t)})}catch(e){G(r,e)}}var Y=0;function V(){return Y++}fun''@;';
put 'put ''ction J(e){e[E]=Y++;e._state=undefined;e._result=undefined;e._subscribers=[]}function z(){return new Error("Array Methods must be provided an Array")}var K=function(){function e(e,t){this._instanceConstructor=e;this.prom''@;';
put 'put ''ise=new e(R);if(!this.promise[E]){J(this.promise)}if(r(t)){this.length=t.length;this._remaining=t.length;this._result=new Array(this.length);if(this.length===0){D(this.promise,this._result)}else{this.length=this.length||''@;';
put 'put ''0;this._enumerate(t);if(this._remaining===0){D(this.promise,this._result)}}}else{G(this.promise,z())}}e.prototype._enumerate=function e(t){for(var r=0;this._state===C&&r<t.length;r++){this._eachEntry(t[r],r)}};e.prototyp''@;';
put 'put ''e._eachEntry=function e(t,r){var n=this._instanceConstructor;var i=n.resolve;if(i===T){var o=void 0;var s=void 0;var u=false;try{o=t.then}catch(e){u=true;s=e}if(o===j&&t._state!==C){this._settledAt(t._state,r,t._result)}''@;';
put 'put ''else if(typeof o!=="function"){this._remaining--;this._result[r]=t}else if(n===te){var a=new n(R);if(u){G(a,s)}else{N(a,t,o)}this._willSettleAt(a,r)}else{this._willSettleAt(new n(function(e){return e(t)}),r)}}else{this._''@;';
put 'put ''willSettleAt(i(t),r)}};e.prototype._settledAt=function e(t,r,n){var i=this.promise;if(i._state===C){this._remaining--;if(t===x){G(i,n)}else{this._result[r]=n}}if(this._remaining===0){D(i,this._result)}};e.prototype._will''@;';
put 'put ''SettleAt=function e(t,r){var n=this;M(t,undefined,function(e){return n._settledAt(P,r,e)},function(e){return n._settledAt(x,r,e)})};return e}();function X(e){return new K(this,e).promise}function $(i){var o=this;if(r(i))''@;';
put 'put ''return new o(function(e,t){for(var r=i.length,n=0;n<r;n++)o.resolve(i[n]).then(e,t)});else return new o(function(e,t){return t(new TypeError("You must pass an array to race."))})}function Q(e){var t=new this(R);return G(''@;';
put 'put ''t,e),t}function Z(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function ee(){throw new TypeError("Failed to construct ''''Promise'''': Please use the ''''new'''' operato''@;';
put 'put ''r, this object constructor cannot be called as a function.")}var te=function(){function t(e){this[E]=V();this._result=this._state=undefined;this._subscribers=[];if(R!==e){typeof e!=="function"&&Z();this instanceof t?W(th''@;';
put 'put ''is,e):ee()}}t.prototype.catch=function e(t){return this.then(null,t)};t.prototype.finally=function e(t){var r=this;var n=r.constructor;if(a(t)){return r.then(function(e){return n.resolve(t()).then(function(){return e})},''@;';
put 'put ''function(e){return n.resolve(t()).then(function(){throw e})})}return r.then(t,t)};return t}();function re(){var e=void 0;if(void 0!==ie)e=ie;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}ca''@;';
put 'put ''tch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var r=null;try{r=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===r&&!''@;';
put 'put ''t.cast)return}e.Promise=te}return te.prototype.then=j,te.all=function(e){return new K(this,e).promise},te.race=function(i){var o=this;return r(i)?new o(function(e,t){for(var r=i.length,n=0;n<r;n++)o.resolve(i[n]).then(e,''@;';
put 'put ''t)}):new o(function(e,t){return t(new TypeError("You must pass an array to race."))})},te.resolve=T,te.reject=function(e){var t=new this(R);return G(t,e),t},te._setScheduler=function(e){o=e},te._setAsap=function(e){s=e},''@;';
put 'put ''te._asap=s,te.polyfill=function(){var e=void 0;if(void 0!==ie)e=ie;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailab''@;';
put 'put ''le in this environment")}var t=e.Promise;if(t){var r=null;try{r=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===r&&!t.cast)return}e.Promise=te},te.Promise=te}()}).call(this,r(4),r(5))},funct''@;';
put 'put ''ion(e,t){var r,n,i=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function u(t){if(r===setTimeout)return setTimeout(t,0);if(''@;';
put 'put ''(r===o||!r)&&setTimeout)return r=setTimeout,setTimeout(t,0);try{return r(t,0)}catch(e){try{return r.call(null,t,0)}catch(e){return r.call(this,t,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:o}catch(e){''@;';
put 'put ''r=o}try{n="function"==typeof clearTimeout?clearTimeout:s}catch(e){n=s}}();var a,c=[],f=!1,l=-1;function h(){f&&a&&(f=!1,a.length?c=a.concat(c):l=-1,c.length&&p())}function p(){if(!f){var e=u(h);f=!0;for(var t=c.length;t;''@;';
put 'put ''){for(a=c,c=[];++l<t;)a&&a[l].run();l=-1,t=c.length}a=null,f=!1,function(t){if(n===clearTimeout)return clearTimeout(t);if((n===s||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(t);try{n(t)}catch(e){try{return n.cal''@;';
put 'put ''l(null,t)}catch(e){return n.call(this,t)}}}(e)}}function d(e,t){this.fun=e,this.array=t}function y(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(1<arguments.length)for(var r=1;r<arguments.length;r++)t[''@;';
put 'put ''r-1]=arguments[r];c.push(new d(e,t)),1!==c.length||f||u(p)},d.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=y,i.addListener=y,''@;';
put 'put ''i.once=y,i.off=y,i.removeListener=y,i.removeAllListeners=y,i.emit=y,i.prependListener=y,i.prependOnceListener=y,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")}''@;';
put 'put '',i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},function(e,t){var r;r=function(){return this}();try{r=r||new Function("return this")()}cat''@;';
put 'put ''ch(e){"object"==typeof window&&(r=window)}e.exports=r}],i.c=n,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineP''@;';
put 'put ''roperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(nu''@;';
put 'put ''ll);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(r,n,function(e){return t[e]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){re''@;';
put 'put ''turn e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0);function i(e){if(n[e])return n[e].exports;var t=n[e]={i:e,l:!1,exports:{}};r''@;';
put 'put ''eturn r[e].call(t.exports,t,t.exports,i),t.l=!0,t.exports}var r,n});'';';
put 'run;';
put '%sasjsout(JS)';
run;
%mv_createwebservice(path=&appLoc/&path, name=&service, code=sascode ,replace=yes)
filename sascode clear;
%let service=scriptsjs;
filename sascode temp lrecl=32767;
data _null_;
file sascode;
put '%macro sasjsout(type,fref=sasjs);';
put '%global sysprocessmode SYS_JES_JOB_URI;';
put '%if "&sysprocessmode"="SAS Compute Server" %then %do;';
put '%if &type=HTML %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name="_webout.json"';
put 'contenttype="text/html";';
put '%end;';
put '%else %if &type=JS %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name=''_webout.js''';
put 'contenttype=''application/javascript'';';
put '%end;';
put '%else %if &type=CSS %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name=''_webout.css''';
put 'contenttype=''text/css'';';
put '%end;';
put '%else %if &type=PNG %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name=''_webout.png''';
put 'contenttype=''image/png'' lrecl=2000000 recfm=n;';
put '%end;';
put '%else %if &type=MP3 %then %do;';
put 'filename _webout filesrvc parenturi="&SYS_JES_JOB_URI" name=''_webout.mp3''';
put 'contenttype=''audio/mpeg'' lrecl=2000000 recfm=n;';
put '%end;';
put '%end;';
put '%else %do;';
put '%if &type=JS %then %do;';
put '%let rc=%sysfunc(stpsrv_header(Content-type,application/javascript));';
put '%end;';
put '%else %if &type=CSS %then %do;';
put '%let rc=%sysfunc(stpsrv_header(Content-type,text/css));';
put '%end;';
put '%else %if &type=PNG %then %do;';
put '%let rc=%sysfunc(stpsrv_header(Content-type,image/png));';
put '%end;';
put '%else %if &type=MP3 %then %do;';
put '%let rc=%sysfunc(stpsrv_header(Content-type,audio/mpeg));';
put '%end;';
put '%end;';
put '%if &type=HTML %then %do;';
put 'filename _sjs temp;';
put 'data _null_;';
put 'file _sjs lrecl=32767 encoding=''utf-8'';';
put 'infile &fref lrecl=32767;';
put 'input;';
put 'if find(_infile_,'' appLoc: '') then do;';
put 'pgm="&_program";';
put 'rootlen=length(trim(pgm))-length(scan(pgm,-1,''/''))-1;';
put 'root=quote(substr(pgm,1,rootlen));';
put 'put ''    appLoc: '' root '','';';
put 'end;';
put 'else if find(_infile_,'' serverType: '') then do;';
put 'if symexist(''_metaperson'') then put ''    serverType: "SAS9" ,'';';
put 'else put ''    serverType: "SASVIYA" ,'';';
put 'end;';
put 'else if find(_infile_,'' hostUrl: '') then do;';
put '/* nothing - we are streaming so this will default to hostname */';
put 'end;';
put 'else put _infile_;';
put 'run;';
put '%let fref=_sjs;';
put '%end;';
put '/* stream byte by byte */';
put '%if &type=PNG or &type=MP3 %then %do;';
put 'data _null_;';
put 'length filein 8 fileout 8;';
put 'filein = fopen("&fref",''I'',4,''B'');';
put 'fileout = fopen("_webout",''A'',1,''B'');';
put 'char= ''20''x;';
put 'do while(fread(filein)=0);';
put 'raw="1234";';
put 'do i=1 to 4;';
put 'rc=fget(filein,char,1);';
put 'substr(raw,i,1)=char;';
put 'end;';
put 'val="123";';
put 'val=input(raw,$base64X4.);';
put 'do i=1 to 3;';
put 'length byte $1;';
put 'byte=byte(rank(substr(val,i,1)));';
put 'rc = fput(fileout, byte);';
put 'end;';
put 'rc =fwrite(fileout);';
put 'end;';
put 'rc = fclose(filein);';
put 'rc = fclose(fileout);';
put 'run;';
put '%end;';
put '%else %do;';
put 'data _null_;';
put 'length filein 8 fileid 8;';
put 'filein = fopen("&fref",''I'',1,''B'');';
put 'fileid = fopen("_webout",''A'',1,''B'');';
put 'rec = ''20''x;';
put 'do while(fread(filein)=0);';
put 'rc = fget(filein,rec,1);';
put 'rc = fput(fileid, rec);';
put 'rc =fwrite(fileid);';
put 'end;';
put 'rc = fclose(filein);';
put 'rc = fclose(fileid);';
put 'run;';
put '%end;';
put '%mend;';
put 'filename sasjs temp lrecl=99999999;';
put 'data _null_;';
put 'file sasjs;';
put 'put ''let sasJs;'';';
put 'put ''let client = "";'';';
put 'put ''let secret = "";'';';
put 'put ''let authcode = "";'';';
put 'put ''function login() {'';';
put 'put ''  const username = document.querySelector("#username").value;'';';
put 'put ''  const password = document.querySelector("#password").value;'';';
put 'put ''  sasJs.logIn(username, password).then((response) => {'';';
put 'put ''    if (response.login === false) {'';';
put 'put ''    } else {'';';
put 'put ''        const loginForm = document.querySelector("#login-form");'';';
put 'put ''        const generateTokenButton = document.querySelector(''''#generate-token'''');'';';
put 'put ''        loginForm.style.display = ''''none'''';'';';
put 'put ''        generateTokenButton.style.display = '''''''';'';';
put 'put ''    }'';';
put 'put ''  });'';';
put 'put ''}'';';
put 'put ''function generateToken() {'';';
put 'put ''    const generateTokenButton = document.querySelector(''''#generate-token'''');'';';
put 'put ''    generateTokenButton.style = ''''opacity: 0.3; pointer-events: none;'''';'';';
put 'put ''    generateTokenButton.innerText = ''''Generating...'''';'';';
put 'put ''    sasJs.request("admin/getapptoken", null, null, (loginRequired) => {'';';
put 'put ''        if (loginRequired) {'';';
put 'put ''            const loginForm = document.querySelector("#login-form");'';';
put 'put ''            loginForm.style.display = '''''''';'';';
put 'put ''            generateTokenButton.style.display = ''''none'''';'';';
put 'put ''        }'';';
put 'put ''      }).then(res => {'';';
put 'put ''        client = res.clientinfo[0].CLIENT;'';';
put 'put ''        secret = res.clientinfo[0].SECRET;'';';
put 'put ''        goToAuthPage();'';';
put 'put ''    });'';';
put 'put ''}'';';
put 'put ''function goToAuthPage() {'';';
put 'put ''    let authUrl = `/SASLogon/oauth/authorize?client_id=${client}&response_type=code`;'';';
put 'put ''    '';';
put 'put ''    fetch(location.origin + authUrl)'';';
put 'put ''    .then(response => response.text())'';';
put 'put ''    .then(response => {'';';
put 'put ''        let authorizeUrl = location.origin + ''''/SASLogon/oauth/authorize'''';'';';
put 'put ''        let params = {};'';';
put 'put ''        '';';
put 'put ''        let responseBody = response.split("<body>")[1].split("</body>")[0];'';';
put 'put ''        let bodyElement = document.createElement("div");'';';
put 'put ''        bodyElement.innerHTML = responseBody;'';';
put 'put ''        let form = bodyElement.querySelector("#application_authorization");'';';
put 'put ''    '';';
put 'put ''        let inputs = form.querySelectorAll("input");'';';
put 'put ''    '';';
put 'put ''        for (let input of inputs) {'';';
put 'put ''          if (input.name === "user_oauth_approval") {'';';
put 'put ''            input.value = "true";'';';
put 'put ''          }'';';
put 'put ''    '';';
put 'put ''          params[input.name] = input.value;'';';
put 'put ''        }'';';
put 'put ''    '';';
put 'put ''        let formData = new FormData();'';';
put 'put ''    '';';
put 'put ''        for (const key in params) {'';';
put 'put ''          if (params.hasOwnProperty(key)) {'';';
put 'put ''            formData.append(key, params[key]);'';';
put 'put ''          }'';';
put 'put ''        }'';';
put 'put ''        fetch(authorizeUrl, {'';';
put 'put ''            method: "POST",'';';
put 'put ''            credentials: "include",'';';
put 'put ''            body: formData,'';';
put 'put ''            referrerPolicy: "same-origin"'';';
put 'put ''        }).then(response => response.text())'';';
put 'put ''        .then(response => {'';';
put 'put ''            let responseBody = response.split("<body>")[1].split("</body>")[0];'';';
put 'put ''            let bodyElement = document.createElement("div");'';';
put 'put ''            bodyElement.innerHTML = responseBody;'';';
put 'put ''            authcode = bodyElement.querySelector(''''.infobox h4'''').innerText;'';';
put 'put ''            let data = {'';';
put 'put ''                ''''fromjs'''': ['';';
put 'put ''                    {'';';
put 'put ''                        client: client,'';';
put 'put ''                        secret: secret,'';';
put 'put ''                        authcode: authcode'';';
put 'put ''                    }'';';
put 'put ''                ]'';';
put 'put ''            }'';';
put 'put ''            sasJs.request(''''common/getrefreshtoken'''', data).then(res => {'';';
put 'put ''                const generateTokenButton = document.querySelector(''''#generate-token'''');'';';
put 'put ''                generateTokenButton.style.display = ''''none'''';'';';
put 'put ''                let tokenInfo = JSON.stringify(res.tokeninfo[0], null, 2)'';';
put 'put ''                  .replace("ACCESS_TOKEN", "access_token")'';';
put 'put ''                  .replace("CLIENT", "client")'';';
put 'put ''                  .replace("SECRET", "secret")'';';
put 'put ''                  .replace("AUTHCODE", "authcode")'';';
put 'put ''                  .replace("REFRESH_TOKEN", "refresh_token");'';';
put 'put ''                let tokenInfoEnv = `access_token=${res.tokeninfo[0].ACCESS_TOKEN}\nclient=${res.tokeninfo[0].CLIENT}\nsecret=${res.tokeninfo[0].SECRET}\nrefresh_token=${res.tokeninfo[0].REFRESH_TOKEN}`;'';';
put 'put ''                let access_token_macro = chunkString(res.tokeninfo[0].ACCESS_TOKEN, 240).join(''''%trim(\r\n)'''');'';';
put 'put ''                let refresh_token_macro = chunkString(res.tokeninfo[0].REFRESH_TOKEN, 240).join(''''%trim(\r\n)'''');'';';
put 'put ''                let tokenInfoMacro = `%let client=${res.tokeninfo[0].CLIENT};<br/>%let secret=${res.tokeninfo[0].SECRET};<br/>%let access_token=${access_token_macro};<br/>%let refresh_token=${refresh_token_macro};<br/>`;'';';
put 'put ''                let tokenInfoP = document.querySelector(''''#token-info'''');'';';
put 'put ''                let tokenInfoMacroP = document.querySelector(''''#token-info-macro'''');'';';
put 'put ''                let tokenInfoEnvP = document.querySelector(''''#token-info-env'''');'';';
put 'put ''                tokenInfoP.innerHTML = tokenInfo;'';';
put 'put ''                tokenInfoP.style = '''''''';'';';
put 'put ''                tokenInfoMacroP.innerHTML = tokenInfoMacro;'';';
put 'put ''                tokenInfoEnvP.innerHTML = tokenInfoEnv;'';';
put 'put ''                let divs=document.getElementsByClassName(''''secHide'''')'';';
put 'put ''                function _removeClasses() {'';';
put 'put ''                  divs[0].classList.remove(''''secHide'''')'';';
put 'put ''                  if (divs[0]) _removeClasses()'';';
put 'put ''                }'';';
put 'put ''                _removeClasses()'';';
put 'put ''            })'';';
put 'put ''        });'';';
put 'put ''    });'';';
put 'put ''}'';';
put 'put ''function chunkString(str, length) {'';';
put 'put ''    return str.match(new RegExp(''''.{1,'''' + length + ''''}'''', ''''g''''));'';';
put 'put ''}'';';
put 'put ''function refreshPage() {'';';
put 'put ''  const origin = window.location.origin'';';
put 'put ''    ? window.location.origin'';';
put 'put ''    : `${window.location.protocol}//${window.location.hostname}${(window.location.port ? '''':'''' + window.location.port : '''''''')}`;'';';
put 'put ''  window.location = `${origin}/SASJobExecution?_PROGRAM=${sasJs.appLoc}/clickme`;'';';
put 'put ''}'';';
put 'put ''function copyText(id) {'';';
put 'put ''  const element = document.getElementById(id);'';';
put 'put ''  const range = document.createRange();'';';
put 'put ''  window.getSelection().removeAllRanges();'';';
put 'put ''  range.selectNode(element);'';';
put 'put ''  window.getSelection().addRange(range);'';';
put 'put ''  document.execCommand("copy");'';';
put 'put ''  alert("Your config has been copied to the clipboard.");'';';
put 'put ''}'';';
put 'run;';
put '%sasjsout(JS)';
run;
%mv_createwebservice(path=&appLoc/&path, name=&service, code=sascode ,replace=yes)
filename sascode clear;